

<div class="container">
  <h5>
    QUẢN TRỊ CÁC FILE CÁ NHÂN
    <button
      type="button"
      class="btn btn-sm btn-danger btn-current-limit"
    ></button>
  </h5>
  <span id="api-name"></span>
  <hr />
  <form>
    <div class="" id="dynamic-vars"></div>
    <div class="input-group mb-3 btn-params-input">
      <div class="input-group-prepend">
        <span
          class="input-group-text input-params"
          id="inputGroup-sizing-default"
          >Tham số:</span
        >
      </div>
      <input
        type="text"
        class="form-control"
        id="params"
        aria-label="Default"
        aria-describedby="inputGroup-sizing-default"
      />
    </div>
    <div class="form-group">
      <small class="form-text text-muted"
        ><span class="" id="server-domain"></span
      ></small>
      <small id="sample-data" class="form-text text-muted"
        >Vui lòng nhập các tham số theo yêu cầu của hàm API</small
      >
    </div>
    <button type="button" class="btn btn-sm btn-primary btn-send-api">
      SEND <i class="fa fa-send icon"></i>
    </button>
    <button
      type="button"
      class="btn btn-sm btn-rounded btn-info btn-file btn-file-upload"
    >
      <input
        class="file-upload file-overlay"
        type="file"
        multiple
        accept=".doc,.docx,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,
                      .xls, .xlsx .csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel,
                      .jpg, .jpeg, .png,
                      image/*,.pdf,
                      audio/*,
                      video/*,
                      .zip,
                      .zar,
                      .txt
                      .json,
                      .md,
                      .svg
                      .ico
                      "
      />
      <i class="fa fa-folder-open icon"></i> Chọn các file để upload
    </button>
  </form>
  <hr />
</div>
<div class="container-content">
  <div class="" id="dynamic-table-model-detail" class="table-editable"></div>
  <p class="col-12 text-left">
    <button type="button" class="btn btn-sm btn-primary btn-read-prev">
      <i class="fa fa-toggle-left icon"></i> Trang trước
    </button>
    <button
      type="button"
      class="btn btn-sm btn-success btn-current-page"
    ></button>
    <button type="button" class="btn btn-sm btn-warning btn-read-next">
      Trang sau <i class="fa fa-toggle-right icon"></i>
    </button>
  </p>
  <hr />
  <p class="col-12 text-right">
    <button
      type="button"
      class="btn btn-sm btn-rounded btn-info btn-table-import"
    >
      Import <i class="fa fa-cloud-upload icon"></i>
    </button>
    <button
      type="button"
      class="btn btn-sm btn-rounded btn-warning btn-table-export"
    >
      <i class="fa fa-cloud-download icon"></i> Export
    </button>
  </p>
  <hr />
  <div class="" id="show-message-status"></div>
</div>

<script>
  // khai báo trong này sẽ không bị lỗi biến đã tồn tại
  $(document).ready(function () {
    hideDefault();
    init();
  });

  function hideDefault() {
    // ẩn đi các nút không cần thiết
    $(".btn-table-import").hide();
    $(".btn-table-export").hide();
    $(".btn-file-upload").hide();
    $(".btn-read-next").hide();
    $(".btn-read-prev").hide();
    $(".btn-current-limit").hide();
    // $(".btn-send-api").hide();
    $(".btn-current-page").hide();
    // $(".btn-params-input").hide();
  }

  // khởi tạo các nút lệnh
  function init() {
    let api, modelParams;
    try {
      api = JSON.parse(API_PARAMS.getKey("api"));
      modelParams = JSON.parse(API_PARAMS.getKey("model-params"));
    } catch {}
    // nếu không có token hoặc hàm api để test thì trở về list-apis
    if (!api || !HOME_PARAMS.token) {
      showToast(
        "warning",
        "Bạn phải đăng nhập trước khi sử dụng chức năng này",
        "toast-top-center",
        2000,
        true
      );

      setTimeout(() => {
        // bắt đầu chuyển sang trang chủ
        window.location.href = "index.html";
      }, 1000);
      return;
    }

    $("#api-name").html(
      `<strong>${api.name}</strong>${
        api.description ? `<br><small>${api.description}</small>` : ""
      }`
    );

    $("#sample-data").html(`${api.form_data || api.sample_data || ""}`);

    let apiPath = `${api.api_router}${api.api_function}`;

    // Hiển thị đường dẫn đầy đủ để copy cho dự án
    showDomainLink(api.method, apiPath);

    // split dấu / để lấy từng đường dẫn
    let apiPathArray = apiPath.split("/");
    // kiểm tra mỗi đường dẫn có dấu : thì trở thành biến để yêu cầu nhập liệu
    let inputVars = apiPathArray.filter((x) => x.indexOf(":") === 0);
    // tạo các ô nhập liệu cho inputVars
    addVarInput(inputVars);

    // ------- INIT PARAMS INPUT --------------//
    // gán các giá trị ban đầu cho tham số lấy được truyền sang
    if (modelParams.params) $("#params").val(modelParams.params); // giá trị mặt định cho tham số params
    // gán các giá trị của biến động mô hình :model_name
    // console.log("***", inputVars, modelParams.model_name);
    if (inputVars.length) {
      for (let oneVar of inputVars) {
        let varName = oneVar.replace(/:/g, "var-");
        if (varName === "var-model_name" && modelParams.model_name) {
          $(`#${varName}`).val(modelParams.model_name);
        }
        if (varName === "var-table_name" && modelParams.table_name) {
          $(`#${varName}`).val(modelParams.table_name);
        }
      }
    }
    // ------- END PARAMS INPUT --------------//

    $(".btn-send-api").html(
      `${api.id ? `(${api.id}) ` : ``}${api.method} ${
        api.base_directory || ""
      }${apiPath}`
    );

    $(".input-params").html(`Tham số ${api.method}:`);

    prepairButtons(api, apiPath, inputVars);
  }

  // sửa soạn các nút để bấm
  function prepairButtons(api, apiPath, inputVars) {
    let fullApiPath = apiPath;
    if (api.method === "GET") {
      $("#params").attr("placeholder", "ví dụ: page=1&limit=100");

      $(".btn-send-api").click(function () {
        let params = $("#params").val();
        // nếu có các biến :inputVar thì phải thay thế trước khi post
        // console.log("***>THAM SỐ:", params);
        // nếu có các biến :xxx thì phải thay bằng giá trị nhập liệu vào
        if (inputVars.length) {
          let keyValues = {};
          for (let oneVar of inputVars) {
            keyValues[oneVar] = $(`#${oneVar.replace(/:/g, "var-")}`).val();
            if (
              keyValues[oneVar] === undefined ||
              keyValues[oneVar] === null ||
              keyValues[oneVar] === ""
            ) {
              $("#dynamic-table-check-api").html(
                `<span class="text-danger">Yêu cầu nhập tham số bắt buộc (*) đầy đủ trước khi gửi</span>`
              );
              return;
            }
          }
          // giá trị nhận được
          fullApiPath = apiPath; // lấy lại gốc phiên trước
          for (let key in keyValues) {
            fullApiPath = fullApiPath.replace(key, keyValues[key]);
          }
        }

        // callAjaxGETApi(fullApiPath, params);
        let ajaxSend = callAjaxGETApiAny(fullApiPath, params, null);
        ajaxSend
          .then((result) => {
            showResultApiData(result);
          })
          .catch((err) => {
            showApiError(err, true);
          });
      });
    }

    if (api.method === "POST") {
      $("#params").attr("placeholder", `ví dụ: {"user":"xyz","status":1}`);

      $(".btn-send-api").click(function () {
        let params;
        try {
          params = JSON.parse($("#params").val());
        } catch {}
        params = params || {};

        // nếu có các biến :xxx thì phải thay bằng giá trị nhập liệu vào
        if (inputVars.length) {
          let keyValues = {};
          for (let oneVar of inputVars) {
            keyValues[oneVar] = $(`#${oneVar.replace(/:/g, "var-")}`).val();
            if (
              keyValues[oneVar] === undefined ||
              keyValues[oneVar] === null ||
              keyValues[oneVar] === ""
            ) {
              $("#dynamic-table-check-api").html(
                `<span class="text-danger">Yêu cầu nhập tham số bắt buộc (*) đầy đủ trước khi gửi</span>`
              );
              return;
            }
          }
          // giá trị nhận được
          fullApiPath = apiPath; // lấy lại gốc phiên trước
          for (let key in keyValues) {
            fullApiPath = fullApiPath.replace(key, keyValues[key]);
          }
        }
        // console.log("xxx>", fullApiPath, params);
        let ajaxSend = callAjaxPOSTApiAny(fullApiPath, params, null);
        ajaxSend
          .then((result) => {
            showResultApiData(result);
          })
          .catch((err) => {
            showApiError(err, true);
          });
      });
    }
  }

  // hiển thị kết quả dữ liệu lên form
  function showResultApiData(result) {
    console.log("Result", result);
    showToast("success", `Đã nhận được kết quả với trang `, null, 5000);
    

  }

  function showDomainLink(method, apiLink) {
    $("#server-domain").text(
      `${method ? `${method} ` : ``}${
        API_PARAMS.getKey("SERVER_DOMAIN", true) || API_PARAMS.SERVER_DOMAIN
      }/media${apiLink ? `${apiLink}` : ``}`
    );
  }

  // thêm các ô nhập liệu để hoàn thành đường dẫn check api
  function addVarInput(inputVars) {
    let htmlVars = ``;
    for (let oneVar of inputVars) {
      let id = oneVar.replace(/:/g, "var-");
      htmlVars += `
            <div class="input-group mb-3">
              <div class="input-group-prepend">
                <span class="input-group-text input-var">${oneVar}:</span>
              </div>
                <input type="text" class="form-control" id="${id}" type="text" class="form-control" name="${id}"
                    placeholder="Tham số bắt buộc (*)">
            </div>
            `;
    }
    $("#dynamic-vars").html(htmlVars);
  }
</script>
