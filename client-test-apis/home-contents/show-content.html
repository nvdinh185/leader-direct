<!-- Đọc ulr lấy danh sách file,
kiểm tra kiểu file nếu là hình ảnh thì view ảnh cỡ nhỏ
kiểu âm thanh hiển thị nút nghe nhạc
kiểu video hiển thị nút xem video
kiểu excel hiển thị biểu tượng excel
kiểu pdf hiển thị kiểu xem file pdf
kiểu word hiển thị kiểu xem word
kiểu html hiển thị xem html - link
 -->
<style>
    .img-responsive {
        height: 33vh;
        width: 100%;
        background: transparent;
        margin: 5px;
    }

    .img-responsive .img-viewer {
        height: 100%;
        position: relative;
        background-repeat: no-repeat;
        background-position: center center;
        background-size: cover;
    }

    .scroll-down-content {
        background: transparent;
        width: 100%;
        margin: 0 auto;
        text-align: center;
    }

    .scroll-down-content img {
        width: 60px;
        min-height: 60px;
    }

    /* .home-image-viewer {
        margin: 0 auto;
        padding: 10px;
    } */
</style>

<div class="jumbotron">
    <div class="container text-center">
        <h1>Website kiểm thử mô hình tự động</h1>
        <p>
            Đây là một công cụ hỗ trợ kiểm thử thư viện API tự động. Sử dụng các phương thức GET, POST của $ajax của
            jquery và thư viện bootstrap một cách nhanh chóng. Qua đó các lập trình viên, học viên có thể hiểu rõ
            các bản chất cơ bản của html, css, js, nodejs. Cách tạo api server tự động, và khai báo để kiểm thử trên
            website này.
        </p>
    </div>
</div>

<div class="container-fluid bg-3 text-center">
    <h3>Một số hoạt động gần đây</h3>
    <br />
    <div class="row home-image-viewer">
        <div class="col-sm-3">
            <p>Ảnh mẫu</p>
            <img src="https://placehold.it/150x80?text=IMAGE" class="img-responsive" style="width: 100%"
                alt="Là ảnh mẫu nhé" />
        </div>
        <div class="col-sm-3">
            <p>Ảnh mẫu</p>
            <img src="https://placehold.it/150x80?text=IMAGE" class="img-responsive" style="width: 100%"
                alt="Là ảnh mẫu nhé" />
        </div>
        <div class="col-sm-3">
            <p>Ảnh mẫu</p>
            <img src="https://placehold.it/150x80?text=IMAGE" class="img-responsive" style="width: 100%"
                alt="Là ảnh mẫu nhé" />
        </div>
        <div class="col-sm-3">
            <p>Ảnh mẫu</p>
            <img src="https://placehold.it/150x80?text=IMAGE" class="img-responsive" style="width: 100%"
                alt="Là ảnh mẫu nhé" />
        </div>
    </div>
</div>

<!-- hình ảnh để kéo xuống hiển thị nội dung -->
<div class="scroll-down-content text-center">
    <div><img src="./imgs/loader.gif" /><br /></div>
</div>


<script>

    // $('.img-viewer').css('background-image', 'url(' + "https://placehold.it/150x80?text=IMAGE" + ')');

    // sử dụng phương thức hiển thị cảnh báo kiểu toast đẹp để thông báo các trạng thái apiÏ
    // showToast(
    //     "warning"
    //     , `Không có file để truyền. Vui lòng chọn lại file`
    //     , "toast-top-right"
    //     , 5000
    // );

    // sử dụng hiển thị showHideLoading để khóa các chức năng khi thực thi hàm api để không làm quá tải máy chủ, 
    // cấm việc thao tác nút bấm nhiều lần khi gọi hàm api để máy chủ không chặn dò quét tự động
    // showHideLoading(true, HOME_PARAMS.totalProgress, HOME_PARAMS.currentProgress);

    // showHideLoading(false);

    // gọi 2 phương thức lấy dữ liệu cơ bản theo Promise tự động
    // callAjaxGETApiAny(apiPath, getParamS, baseUrlFull)
    // callAjaxPOSTApiAny(apiPath, jsonParams, baseUrlFull)

    // START - Bắt đầu với hàm này như main trong java 
    $(function () {

        $(".scroll-down-content").hide();

        // lấy các biến cơ bản của trang để lấy dữ liệu
        let api = {
            function_api: "/files/post-public-page"
        };
        let modelParams = {
            page: 1
            , limit: 16
            , wheres: { type: { $in: ["image/jpeg", "video/mp4"] } }
            , sorts: { time: -1 }
        };

        if (!HOME_PARAMS.token) {
            // không có token thì không làm gì cả để trang chủ trở về trạng thái bình thường
            return;
        }

        // reset ban đầu
        HOME_PARAMS.currentOffset = 0;
        getNextPage("/files/post-public-page", {
            page: 1
            , limit: 16
            , wheres: { type: { $in: ["video/mp4", "image/jpeg"] } }
            , sorts: { created_time: -1 }
        });

    });

    /**
     * Cho phép đọc từng trang để hiển thị ảnh
     */
    function getNextPage(apiLink, jsonParams, page = 1, mediaServer = "https://socket.cng.vn/media") {
        // mọi thứ đã sẵn sàng lấy dữ liệu theo file
        callAjaxPOSTApiAny(
            apiLink
            , {
                ...jsonParams
                , page
            },
            mediaServer
        )
            .then(result => {
                if (result && result.data) {
                    if (!HOME_PARAMS.isNextPage) {
                        HOME_PARAMS.sheetDatas = result.data;
                    } else {
                        HOME_PARAMS.sheetDatas.splice(HOME_PARAMS.sheetDatas.length, 0, ...result.data);
                    }

                    // console.log("KQ", result.data);

                    HOME_PARAMS.currentPage = result.page;
                    if (result.next_page > result.page) {
                        HOME_PARAMS.isNextPage = true;
                    } else {
                        // hết dữ liệu trang kế tiếp rồi nên nó phải là false
                        HOME_PARAMS.isNextPage = false;
                    }

                    if (!HOME_PARAMS.ajaxBlock) {
                        // console.log("GỌI HÀM Đầu tiên");
                        HOME_PARAMS.ajaxBlock = true; // thiết lập thời gian trễ sau đó mới được phép gọi lại
                        setTimeout(() => {
                            showImageViewer(HOME_PARAMS.currentOffset);
                            HOME_PARAMS.ajaxBlock = false; // hiển thị xong mới cho phiên tiếp theo
                        }, 1000); // đợi 5 giây sau mới hiển thị kết quả
                    }
                }
            })
            .catch(err => {
                showApiError(err);
            });
    }

    function showImageViewer(offset = 0, range = 16, mediaServer = "https://socket.cng.vn/media") {
        const urlServer = mediaServer || `${API_PARAMS.getKey("SERVER_DOMAIN", true) || API_PARAMS.SERVER_DOMAIN
            }${API_PARAMS.getKey("BASE_DIRECTORY", true) ||
            API_PARAMS.BASE_DIRECTORY
            }`
        let html = ``;

        if (offset >= HOME_PARAMS.sheetDatas.length) {
            // hết dữ liệu rồi --hãy đọc tiếp trong csdl trang kế tiếp
            if (HOME_PARAMS.isNextPage) {
                getNextPage("/files/post-public-page", {
                    page: 1
                    , limit: 16
                    , wheres: { type: { $in: ["video/mp4", "image/jpeg"] } }
                    , sorts: { created_time: -1 }
                },
                    HOME_PARAMS.currentPage + 1
                );
            }
            return;
        }

        let endOffset = offset + range;
        if (endOffset >= HOME_PARAMS.sheetDatas.length) {
            endOffset = HOME_PARAMS.sheetDatas.length;
        }


        let viewpage = HOME_PARAMS.sheetDatas.slice(offset, endOffset);
        for (let file of viewpage) {
            if (file.type && file.type.indexOf("image") >= 0) {
                // kiểu ảnh theo độ cao định sẵn không méo hình
                html += `
                <div class="col-sm-3">
                    <div class="card img-responsive">
                       <div class="img-viewer" style="background-image: url('${urlServer}/files/get-public-file/${file.id}?size=600');"></div>
                    </div>
                    <div class="card-body">
                        <p class="card-text">${file.owner} - ${file.name}</p>
                    </div>
                </div>`;
            } else if (file.type && file.type.indexOf("video") >= 0) {
                html += `
                <div class="col-sm-3">
                    <div class="card img-responsive">
                        <div class="img-viewer embed-responsive embed-responsive-16by9">
                            <iframe class="embed-responsive-item"
                                src="${urlServer}/files/get-public-file/${file.id}?size=600" allowfullscreen></iframe>
                        </div>
                    </div>
                    <div class="card-body">
                        <p class="card-text">${file.owner} - ${file.name}</p>
                    </div>
                </div>`;
                // console.log(file);
            } else {
                // console.log(file);
            }
        }

        if (HOME_PARAMS.currentOffset) {
            $(".home-image-viewer").append(`${html}`);
        } else {
            $(".home-image-viewer").html(`${html}`);
        }
        HOME_PARAMS.currentOffset = endOffset;
    }
</script>


<script>

    $(window).scroll(function () {
        if ($(document).height() - $(this).height() == $(this).scrollTop()) {
            if (!HOME_PARAMS.ajaxBlock
                && (HOME_PARAMS.isNextPage // còn trong csdl
                    || HOME_PARAMS.currentOffset < HOME_PARAMS.sheetDatas.length) // còn trong bộ nhớ
            ) {
                HOME_PARAMS.ajaxBlock = true; // thiết lập thời gian trễ sau đó mới được phép gọi lại
                $(".scroll-down-content").show();
                setTimeout(() => {
                    showImageViewer(HOME_PARAMS.currentOffset);
                    HOME_PARAMS.ajaxBlock = false; // hiển thị xong mới cho phiên tiếp theo
                    $(".scroll-down-content").hide();
                }, 1000);
            }
        }
    }); 
</script>