<div class="container">
  <h5>
    <button type="button" class="btn btn-sm btn-primary btn-back-home">
      <i class="fa fa-home icon"></i>
      Home
    </button>
    FUNCTION_APIS
    <button
      type="button"
      class="btn btn-sm btn-danger btn-current-limit"
    ></button>
  </h5>
  <div class="form-group">
    <small class="form-text text-muted"
      ><span class="" id="server-domain"></span
    ></small>
  </div>
</div>

<div class="container-content">
  <div class="" id="dynamic-table"></div>
  <p>
    <button type="button" class="btn btn-sm btn-primary btn-read-prev">
      <i class="fa fa-toggle-left icon"></i> Trang trước
    </button>
    <button type="button" class="btn btn-sm btn-success btn-current-page"></button>
    <button type="button" class="btn btn-sm btn-warning btn-read-next">
      Trang sau <i class="fa fa-toggle-right icon"></i>
    </button>
  </p>
</div>
<hr />

<script>
  function arrayObject2HtmlTable(rows) {
    if (!rows || !Array.isArray(rows)) {
      return `<table cellspacing="0" id="table-datatables" class="table table-sm table-bordered table-striped"></table>`;
    }
    let html =
      '<table cellspacing="0" id="table-datatables" class="table table-sm table-bordered table-striped">';
    let header = {};
    for (let row of rows) {
      let r = {};
      for (let key in row) {
        if (key !== "_id") r[key] = 1;
      }
      header = { ...header, ...r };
    }
    html += "<thead><tr>";
    for (let key in header) {
      html += "<th>" + key + "</th>";
    }
    html += "</tr></thead>";
    html += "<tbody>";
    for (let row of rows) {
      html += "<tr>";
      let i = 0;
      for (let key in header) {
        i++;
        html +=
          (i === 1 ? '<td><span class="co-name">' : "<td>") +
          (i === 1
            ? '<button type="button" class="btn btn-sm btn-success btn-read-one" onclick="readOneApi(this);">'
            : "") +
          (row[key] === undefined || row[key] === null ? "" : row[key]) +
          (i === 1 ? "</span></td>" : "</td>");
      }
      html += "</tr>";
    }
    html += "</tbody>";
    html += "</table>";
    return html;
  }

  // gọi ajax lấy dữ liệu các hàm api
  function callAjax(page, limit) {
    $("body").addClass("loading");
    $.ajax({
      type: "GET",
      headers: { Authorization: `Bearer ${HOME_PARAMS.token}` },
      url: `${
        API_PARAMS.getKey("SERVER_DOMAIN", true) || API_PARAMS.SERVER_DOMAIN
      }${
        API_PARAMS.getKey("BASE_DIRECTORY", true) || API_PARAMS.BASE_DIRECTORY
      }${API_PARAMS.APIs}?page=${page}&limit=${limit}`,
      success: (result) => {
        // console.log(result);
        HOME_PARAMS.sheetDatas = result.data;
        $("#dynamic-table").html(arrayObject2HtmlTable(result.data));

        $(".btn-current-page").text(result.page);
        if (result.page > 1) {
          $(".btn-read-prev").show();
        } else {
          $(".btn-read-prev").hide();
        }
        if (result.next_page > result.page) {
          $(".btn-read-next").show();
        } else {
          $(".btn-read-next").hide();
        }
        // thay đổi phân trang
        if (HOME_PARAMS.sheetDatas.length) {
          $("#table-datatables").DataTable({
            scrollX: "100%",
            scrollY: "400px",
            scrollCollapse: true,
            drawCallback: function (settings) {
              $("#table-datatables").reflowTable("update");
            },
            ...HOME_PARAMS.DATA_TABLE_PAGING
          });
          $("#table-datatables").reflowTable();
        }

        $("body").removeClass("loading");
      },
      error: (err) => {
        showApiError(err);
        $("body").removeClass("loading");
      },
      dataType: "json",
    });
  }

  $(function () {
    HOME_PARAMS.currentPage = 1;
    HOME_PARAMS.limit = 100;

    $("#server-domain").text(
      `${API_PARAMS.getKey("SERVER_DOMAIN", true) || API_PARAMS.SERVER_DOMAIN}${
        API_PARAMS.getKey("BASE_DIRECTORY", true) || API_PARAMS.BASE_DIRECTORY
      }`
    );

    $(".btn-current-page").text(HOME_PARAMS.currentPage);
    $(".btn-current-limit").text(HOME_PARAMS.limit);

    $(".btn-read-prev").hide();
    $(".btn-read-next").hide();

    // $(".btn-read-apis").click(function () {
    callAjax(HOME_PARAMS.currentPage, HOME_PARAMS.limit);
    //   });
    $(".btn-read-prev").click(function () {
      callAjax(--HOME_PARAMS.currentPage, HOME_PARAMS.limit);
    });
    $(".btn-read-next").click(function () {
      callAjax(++HOME_PARAMS.currentPage, HOME_PARAMS.limit);
    });

    $(".btn-back-home").click(function () {
      window.location.href = `index.html`;
    });
  });

  function readOneApi(thisObj) {
    const $tableID = $("#dynamic-table");
    const $rows = $tableID.find("tr:not(:hidden)");
    // A few jQuery helpers for exporting only
    jQuery.fn.pop = [].pop;
    jQuery.fn.shift = [].shift;

    // lấy dòng đầu tiên
    const headers = [];
    // Get the headers (add special header logic here)
    // lấy dòng đầu tiên làm khóa key - dòng headers
    $($rows.shift())
      .find("th:not(:empty)")
      .each(function () {
        // chuyển đổi khóa key đó thành chữ thường để đưa ra mảng json đúng
        // yêu cầu khóa key ở cột đó phải khác nhau, nếu đặt trùng nhau sẽ lấy giá trị bị sai
        headers.push($(this).text().toLowerCase());
      });

    // lấy chính dòng dữ liệu đang bấm nút trên đó
    const $row = $(thisObj).parents("tr");
    $row.each(function () {
      // với mỗi dòng, tìm kiếm tất cả các cột, (theo thứ tự)
      const $td = $(this).find("td");
      const jsonData = {};
      // Use the headers from earlier to name our hash keys
      headers.forEach((header, i) => {
        // duyệt tuần tự các cột hiện có theo thứ tự
        // và lấy nội dung text lưu trữ bên trong table để gán cho json một cột của dòng
        jsonData[header] = $td.eq(i).text();
      });
      // lọc được tất cả các cột để đưa vào mệnh đề select luôn?
      // chuyển qua trang tương tác của bảng theo mô hình đó
      API_PARAMS.saveKey(
        "api",
        JSON.stringify(
          jsonData,
          (key, value) => {
            if (typeof value === "string") return value.replace(/^\s/g, "");
            return value;
          },
          2
        )
      );

      let params = "";

      let sampleData;
      try {
        if (jsonData.sample_data) {
          sampleData = JSON.parse(jsonData.sample_data);
        }
      } catch {}

      // console.log("dữ liệu mẫu", sampleData);

      if (sampleData) {
        if (typeof sampleData === "string") {
          params = sampleData;
        } else if (Array.isArray(sampleData) && sampleData.length > 0) {
          if (typeof sampleData[0] === "string") {
            params = sampleData[0];
          } else if (typeof sampleData[0] === "object") {
            params = JSON.stringify(sampleData[0]);
          }
        } else if (typeof sampleData === "object") {
          params = JSON.stringify(sampleData);
        }
      }

      // lưu lại tham số mặt định để chuyển sang là tự đọc luôn tham số không cần bấm
      // đọc các tham số trong sample_data để gán mặt định vào param nhé
      API_PARAMS.saveKey(
        "model-params",
        JSON.stringify({
          params, // đây là tham số mặt định để test thử trong sample_data
        })
      );

      $("#content-nav").load("./home-contents/show-check-api.html");
    });
  }
</script>
