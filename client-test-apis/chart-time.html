<!DOCTYPE html>
<html>

<head>

    <title>Mẫu chart time</title>

    <link rel="icon" type="image/png" href="./icon/favicon.png" />
    <meta charset="utf-8" />

    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />

    <!-- Lấy toàn bộ icon để vẽ cho nút -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />

    <link rel="stylesheet" href="./css/bootstrap-4.3.1-min.css" />

    <script src="./js/jquery.min.js"></script>
    <script src="./js/popper-1.14.3-min.js"></script>
    <script src="./js/bootstrap-4.3.1-min.js"></script>

    <script src="./js/md5.js"></script>

    <link rel="stylesheet" href="./css/loading-style.css" />


    <!-- Nhúng thư viện socket vào đây để login bằng socket -->
    <script src="./js/www.client.socket.login.js"></script>
    <!-- Khai báo các biến dùng chung ở đây yêu cầu load lại file này thì khai báo tên khác mỗi lần install -->
    <script src="./js/config/params-window.js"></script>

    <!-- Thư viện về xử lý thời gian ngày/giờ -->
    <script src="./js/chart-js/moment.min.js"></script>
    <!-- thư viện về chartjs -->
    <script src="./js/chart-js/chart.min.js"></script>
    <script src="./js/chart-js/utils-.js"></script>


    <!-- tableEditable -->
    <link href="./css/reflow-table.css" rel="stylesheet" type="text/css" />
    <link href="./css/datatables.min.css" rel="stylesheet" type="text/css" />
    <script src="./js/get-query-param.js"></script>
    <script src="./js/reflow-table.js"></script>
    <script src="./js/datatables.min.js"></script>


    <style>
        .object-center {
            width: 300px;
            height: 300px;
            border: 2px solid black;

            margin: 0px auto;
            text-align: center;
        }

        /* chặn không cho chọn trên biểu đồ */
        canvas {
            -moz-user-select: none;
            -webkit-user-select: none;
            -ms-user-select: none;
        }

        canvas .cng-chart-size {
            /* border: 1px solid blue; */
            width: 200px;
            height: 200px;
        }
    </style>
</head>

<body>

    <div class="container">
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" id="home-tab" data-toggle="tab" href="#home" role="tab" aria-controls="home"
                    aria-selected="true">Số liệu</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="pie-tab" data-toggle="tab" href="#pie" role="tab" aria-controls="pie"
                    aria-selected="false">Pie</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="bar-tab" data-toggle="tab" href="#bar" role="tab" aria-controls="bar"
                    aria-selected="false">Bar</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="line-tab" data-toggle="tab" href="#line" role="tab" aria-controls="line"
                    aria-selected="false">Line</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="time-tab" data-toggle="tab" href="#time" role="tab" aria-controls="time"
                    aria-selected="false">Time</a>
            </li>
        </ul>
        <div class="tab-content" id="myTabContent">
            <div class="tab-pane fade show active" id="home" role="tabpanel" aria-labelledby="home-tab">
                <br>
                <!-- Bảng thống kê -->
                <div class="" id="dynamic-table"></div>
            </div>
            <div class="tab-pane fade" id="pie" role="tabpanel" aria-labelledby="pie-tab">
                <!-- Đồng chỉnh tâm canh giữa -->
                <div class="object-center">
                    <canvas class="cng-chart-size" id="chart-pie" width="200" height="200"></canvas>
                </div>
            </div>
            <div class="tab-pane fade" id="bar" role="tabpanel" aria-labelledby="bar-tab">
                <div class="object-center">
                    <canvas class="cng-chart-size" id="chart-bar" width="200" height="200"></canvas>
                </div>
            </div>
            <div class="tab-pane fade" id="line" role="tabpanel" aria-labelledby="line-tab">
                <div class="object-center">
                    <canvas class="cng-chart-size" id="chart-line" width="200" height="200"></canvas>
                </div>
            </div>
            <div class="tab-pane fade" id="time" role="tabpanel" aria-labelledby="time-tab">
                <div class="">
                    <canvas class="" id="chart-time" width="1000" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>


    <!-- Nhúng đối tượng tổ chức bảng, form tableFlow, ... -->
    <script src="./js/dynamic-form/dynamic-form.js"></script>
    <script>

        /**
        * Hiển thị nội dung ra bảng
        */
        function viewTableData(result) {

            const formDatas = new JSCngDynamicForm();

            // khai báo các nút lệnh trên từng dòng để khai báo xóa file và chỉnh sửa file
            let buttons = `<button type="button" class="btn btn-sm btn-rounded btn-primary btn-read-one" onclick="doCommandOneRow(this,'R');">
      <i class="fa fa-download icon"></i> Xem
      </button>
      <button type="button" class="btn btn-sm btn-rounded btn-success btn-read-one" onclick="doCommandOneRow(this,'U');">
      <i class="fa fa-edit icon"></i> Sửa
      </button>
      <button type="button" class="btn btn-sm btn-rounded btn-danger btn-read-one" onclick="doCommandOneRow(this,'D');">
      <i class="fa fa-trash icon"></i> Xóa
      </button>`;

            // nút lệnh hiển thị nội dung chi tiết nếu kết quả trả về là một đối tượng, chứa thông tin chi tiết hơn
            let viewCommand = `<button type="button" class="btn btn-sm btn-rounded btn-info btn-read-one" onclick="doCommandOneCell(this,'V');">
              <i class="fa fa-eye icon"></i> ...
          </button>`

            // định nghĩa các tên trường (cột) cho bảng biết trước để sắp xếp theo ý muốn (nếu có)
            // Để cho phép hiển thị theo thứ tự (1), edit cột đó (2), hoặc ẩn cột đó đi (0), (hoặc chuyển đổi định dạng??? - format??? - viết sau)
            let headers = {
                // id: 1,
                // name: 2,
                // type: 1,
                // size: 1,
                // updated_time: 1,
                // owner: 1,
                // is_private: 2,
                // url_user: 0,
                // url_local: 0,
                // created_time: 0
            };

            // Tạo một bảng dữ liệu theo kết quả lấy được, khai trường "id" làm id của dòng để tham chiếu duy nhất
            let htmlTable = formDatas.arrayObject2HtmlTable(result, headers, null, false, false, null, viewCommand);

            // console.log("Kết quả ", htmlTable);

            if (htmlTable) {

                $("#dynamic-table").html(htmlTable);

                // // cập nhập phân trang cho bảng nếu cần
                // $("#table-datatables").DataTable({
                //     drawCallback: function (settings) {
                //         $("#table-datatables").reflowTable("update");
                //     },
                //     scrollX: "100%",
                //     scrollY: "300px",  // chỉ 1 dòng nên hiển thị thấp thôi
                //     // ...window.HOME_PARAMS.DATA_TABLE_PAGING,
                // });
                // chỉ hiển thị ở chế độ mobile thôi

                $("#table-datatables")
                    .reflowTable({
                        autoWidth: false, // thiết lập luôn ở chế độ table, không cho tự chuyển về mobile
                    })
                    // .mobileMode(true)  // chỉ hiển thị kiểu mobile thôi
                    ;
            }
        }
    </script>

    <!-- vẽ chart -->
    <script>

        var randomScalingFactor = function () {
            return Math.round(Math.random() * 100);
        };

        /**
         * Cập nhập lại dữ liệu cho biểu đồ bằng hàm sau
         */
        function updateData(data) {
            // yêu cầu có biểu đồ đã khởi tạo, và dữ liệu hợp lệ
            if (window.cngChart
                && window.config
                && window.config.data
                && window.config.data.datasets) {
                window.config.data.datasets.forEach(function (dataset) {
                    dataset.data = data
                });
                window.cngChart.update();
            }
        }

        /**
         * Thêm một bộ thống kê cho biểu đồ
         */
        function addDataset(dataSet) {
            // yêu cầu có biểu đồ đã khởi tạo, và dữ liệu hợp lệ
            if (window.cngChart
                && window.config
                && window.config.data
                && window.config.data.datasets
                && window.config.data.labels
            ) {
                var newDataset = {
                    backgroundColor: [],
                    data: [],
                    label: 'Dataset #' + window.config.data.datasets.length,
                };

                var colorNames = Object.keys(window.chartColors);

                for (var index = 0; index < window.config.data.labels.length; ++index) {
                    newDataset.data.push(randomScalingFactor());

                    var colorName = colorNames[index % colorNames.length];
                    var newColor = window.chartColors[colorName];
                    newDataset.backgroundColor.push(newColor);
                }

                window.config.data.datasets.push(newDataset);

                window.cngChart.update();
            }
        }

        /**
         * Xóa bộ thống kê trong biểu đồ
         */
        function removeDataset(idx) {
            // yêu cầu có biểu đồ đã khởi tạo, và dữ liệu hợp lệ
            if (window.cngChart
                && window.config
                && window.config.data
                && window.config.data.datasets
            ) {
                config.data.datasets.splice(idx, 1);
                window.cngChart.update();
            }
        }

        /**
         * chartDatas:mảng dữ liệu chứa [{key:value of number}...]
         * trả về { datasets, labels }
         */
        function createDataSets(chartDatas, type = "pie", label) {

            let datasets = [];        // dữ liệu vẽ biểu đồ 
            let labels = [];          // nhãn cho chart

            // bộ màu cho trước ở utils
            var colorNames = Object.keys(window.chartColors);
            var color = Chart.helpers.color;

            if (!chartDatas || !Array.isArray(chartDatas)) {
                return { datasets, labels };
            }

            // màu nền theo khóa key theo đối tượng
            let keyBackgroundColor = {};

            // màu cho chart
            let chartColor = {
                backgroundColor: color(window.chartColors.blue).alpha(0.5).rgbString(),
                borderColor: window.chartColors.blue,
                borderWidth: 1,
            };


            // dữ liệu tạo ra 
            if (type === "line-time") {

                data = chartDatas;

                datasets.push({
                    ...chartColor, // đưa màu chart
                    data,
                    fill: false, // nếu muốn cho làm đầy thì để true
                    type: 'line',
                    pointRadius: 0,
                    lineTension: 0,
                    borderWidth: 2,
                    label: `${label || type}` // nhãn của mỗi dataset - ghi ở trên đầu
                });

                return { datasets, labels };
            }


            let idxRow = 0;
            for (let chartData of chartDatas) {
                // kiểm tra mảng chứa đối tượng mà có đội dài thì vẽ
                if (typeof chartData === "object"
                    && Object.keys(chartData).length !== 2 // phải là đối tượng và chứa key cùng value mới cho vẽ nhé
                ) {
                    let data = [];            // dữ liệu cho chart
                    labels = [...Object.keys(chartData)]; // chỉ gán nhãn 1 lần thôi
                    let idxCol = 0;
                    for (let key in chartData) {
                        keyBackgroundColor[key] = colorNames[idxCol++];
                        let value = parseFloat(chartData[key]);
                        data.push(value);
                    }

                    // phối màu nền theo key
                    if (type === "pie") {
                        //color(window.chartColors.blue).alpha(0.5).rgbString();
                        // làm mờ màu xuống 50%
                        chartColor = {
                            backgroundColor: Object.values(keyBackgroundColor).map(x => color(x).alpha(0.5).rgbString()),
                            // borderColor: Object.values(keyBackgroundColor),
                            borderWidth: 1,
                        };
                    } else if (type === "bar") {
                        if (chartDatas.length > 1) {
                            // nếu có nhiều dataset (nhiều đường biểu diễn), thì mỗi key là 1 nhóm màu
                            let newColor = colorNames[idxRow++];
                            chartColor = {
                                backgroundColor: color(newColor).alpha(0.3).rgbString(),
                                borderColor: newColor,
                                borderWidth: 1,
                            };
                        } else {
                            //color(window.chartColors.blue).alpha(0.5).rgbString();
                            // làm mờ màu xuống 30%
                            chartColor = {
                                backgroundColor: Object.values(keyBackgroundColor).map(x => color(x).alpha(0.3).rgbString()),
                                borderColor: Object.values(keyBackgroundColor),
                                borderWidth: 1,
                            };
                        }
                    } else if (type === "line-time") { // đường biễu diễn thời gian
                        if (chartDatas.length > 1) {
                            // nếu có nhiều dataset (nhiều đường biểu diễn), thì mỗi key là 1 nhóm màu
                            let newColor = colorNames[idxRow++];
                            chartColor = {
                                backgroundColor: color(newColor).alpha(0.3).rgbString(),
                                borderColor: newColor,
                                fill: false, // nếu muốn cho làm đầy thì để true
                                type: 'line',
                                pointRadius: 0,
                                lineTension: 0,
                                borderWidth: 2
                            };
                        } else {
                            //color(window.chartColors.blue).alpha(0.5).rgbString();
                            // làm mờ màu xuống 30%
                            chartColor = {
                                backgroundColor: Object.values(keyBackgroundColor).map(x => color(x).alpha(0.3).rgbString()),
                                borderColor: Object.values(keyBackgroundColor),
                                borderWidth: 2,
                                fill: false,
                                type: 'line',
                                pointRadius: 0,
                                lineTension: 0,
                                borderWidth: 2
                            };
                        }

                    } else { //if (type === "line")
                        if (chartDatas.length > 1) {
                            // nếu có nhiều dataset (nhiều đường biểu diễn), thì mỗi key là 1 nhóm màu
                            let newColor = colorNames[idxRow++];
                            chartColor = {
                                backgroundColor: color(newColor).alpha(0.3).rgbString(),
                                borderColor: newColor,
                                borderWidth: 1,
                                fill: false, // nếu muốn cho làm đầy thì để true
                            };
                        } else {
                            //color(window.chartColors.blue).alpha(0.5).rgbString();
                            // làm mờ màu xuống 30%
                            chartColor = {
                                backgroundColor: Object.values(keyBackgroundColor).map(x => color(x).alpha(0.3).rgbString()),
                                borderColor: Object.values(keyBackgroundColor),
                                borderWidth: 1,
                                fill: false,
                            };
                        }
                    };

                    datasets.push({
                        ...chartColor, // đưa màu chart
                        data,
                        label: `${label || type}#${idxRow}` // nhãn của mỗi dataset - ghi ở trên đầu
                    });

                }
            }

            return { datasets, labels };

        }


        /**
         * 
         * Vẽ biểu đồ bằng cấu hình
         * 
         * chartId: id của canvas
         * 
         * type: các kiểu hỗ trợ  pie | bar | ...
         * 
         * chartData: dữ liệu phù hợp với type theo quy định
         * {field_i: count_float_i, ...} hoặc [{}]
         * 
         * label: tên biểu đồ này là gì
         * 
         */
        function drawChart(
            chartId
            , type
            , chartData
            , label
            , options = {
                responsive: true
            }
        ) {

            if (!chartId || !type || !chartData || typeof chartData !== "object") {
                return;
            }

            // console.log("*****>CCC");

            let data = Array.isArray(chartData) ? createDataSets(chartData, type, label) : createDataSets([chartData], type, label);

            // console.log("*****>BBBB--->", data.datasets);

            let cngChart = `cng-${chartId}`;
            window.ctx = $(`#${chartId}`)[0].getContext('2d');

            if (window.ctx) {

                if (!window[`${cngChart}-config`]) {
                    var color = Chart.helpers.color;
                    window[`${cngChart}-config`] = {
                        type,
                        data: {
                            datasets: data.datasets
                        },
                        options
                    };
                } else {
                    window[`${cngChart}-config`].data = data;
                };

                // console.log("Cấu hình nè:", window[`${cngChart}-config`]);

                if (!window[cngChart]) {
                    window[cngChart] = new Chart(window.ctx, window[`${cngChart}-config`]);
                } else {
                    window[cngChart].update();
                }

            }
        }

        // khai báo trong này sẽ không bị lỗi biến đã tồn tại
        $(document).ready(function () {

            let chartData = [
                {
                    t: Date.now()-1,
                    y: randomScalingFactor()
                },
                {
                    t: Date.now(),
                    y: randomScalingFactor()
                }
            ];
            // let chartData = [
            //     {
            //         t: Date.now()-1,
            //         y: randomScalingFactor()
            //     },
            //     {
            //         t: Date.now(),
            //         y: randomScalingFactor()
            //     }
            // ];

            // hiển thị bảng dữ liệu
            viewTableData(chartData);

            // Lắng nghe sự kiện bấm trên tab để lấy thuộc tính, khóa chính để thực thi nhiệm vụ
            $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {

                // console.log(e.target, e.relatedTarget);
                // e.target // newly activated tab
                // e.relatedTarget // previous active tab
                // console.log ( $(e.target).attr('id') );

                const activeTabId = $(e.target).attr('id');

                switch (activeTabId) {
                    case "pie-tab":
                        drawChart("chart-pie", "pie", chartData, "Biểu đồ bánh");
                        break;
                    case "bar-tab":
                        drawChart("chart-bar", "bar", chartData, "Biểu đồ hình thanh", {
                            scales: {
                                yAxes: [{
                                    ticks: {
                                        beginAtZero: true
                                    }
                                }]
                            }
                        });
                        break;
                    case "line-tab":

                        var timeFormat = 'DD/MM/YYYY HH:mm';

                        drawChart("chart-line", "line", chartData, "Biểu diễn theo thời gian"
                            , {

                            }
                        );
                        break;
                    case "time-tab":

                        drawChart("chart-time", "line-time", chartData, "Biểu diễn doanh thu, tài chính theo thời gian"
                            , {
                                animation: {
                                    duration: 0
                                },
                                scales: {
                                    xAxes: [{
                                        type: 'time',
                                        distribution: 'series',
                                        offset: true,
                                        ticks: {
                                            major: {
                                                enabled: true,
                                                fontStyle: 'bold'
                                            },
                                            source: 'data',
                                            autoSkip: true,
                                            autoSkipPadding: 75,
                                            maxRotation: 0,
                                            sampleSize: 100
                                        },
                                        afterBuildTicks: function (scale, ticks) {
                                            var majorUnit = scale._majorUnit;
                                            var firstTick = ticks[0];
                                            var i, ilen, val, tick, currMajor, lastMajor;

                                            val = moment(ticks[0].value);
                                            if ((majorUnit === 'minute' && val.second() === 0)
                                                || (majorUnit === 'hour' && val.minute() === 0)
                                                || (majorUnit === 'day' && val.hour() === 9)
                                                || (majorUnit === 'month' && val.date() <= 3 && val.isoWeekday() === 1)
                                                || (majorUnit === 'year' && val.month() === 0)) {
                                                firstTick.major = true;
                                            } else {
                                                firstTick.major = false;
                                            }
                                            lastMajor = val.get(majorUnit);

                                            for (i = 1, ilen = ticks.length; i < ilen; i++) {
                                                tick = ticks[i];
                                                val = moment(tick.value);
                                                currMajor = val.get(majorUnit);
                                                tick.major = currMajor !== lastMajor;
                                                lastMajor = currMajor;
                                            }
                                            return ticks;
                                        }
                                    }],
                                    yAxes: [{
                                        gridLines: {
                                            drawBorder: false
                                        },
                                        scaleLabel: {
                                            display: true,
                                            labelString: 'Giá theo thời gian ($)'
                                        }
                                    }]
                                },
                                tooltips: {
                                    intersect: false,
                                    mode: 'index',
                                    callbacks: {
                                        label: function (tooltipItem, myData) {
                                            var label = myData.datasets[tooltipItem.datasetIndex].label || '';
                                            if (label) {
                                                label += ': ';
                                            }
                                            label += parseFloat(tooltipItem.value).toFixed(2);
                                            return label;
                                        }
                                    }
                                }
                            }
                        );
                        break;
                    default:
                        break;
                }
            })

        });

        function generateData() {
            var unit = 'hour';

            function unitLessThanDay() {
                return unit === 'second' || unit === 'minute' || unit === 'hour';
            }

            function beforeNineThirty(date) {
                return date.hour() < 9 || (date.hour() === 9 && date.minute() < 30);
            }

            // Returns true if outside 9:30am-4pm on a weekday
            function outsideMarketHours(date) {
                if (date.isoWeekday() > 5) {
                    return true;
                }
                if (unitLessThanDay() && (beforeNineThirty(date) || date.hour() > 16)) {
                    return true;
                }
                return false;
            }

            function randomNumber(min, max) {
                return Math.random() * (max - min) + min;
            }

            function randomBar(date, lastClose) {
                var open = randomNumber(lastClose * 0.95, lastClose * 1.05).toFixed(2);
                var close = randomNumber(open * 0.95, open * 1.05).toFixed(2);
                return {
                    t: date.valueOf(),
                    y: close
                };
            }

            var date = moment('Jan 01 1990', 'MMM DD YYYY');
            var now = moment();
            var data = [];
            var lessThanDay = unitLessThanDay();
            for (; data.length < 600 && date.isBefore(now); date = date.clone().add(1, unit).startOf(unit)) {
                if (outsideMarketHours(date)) {
                    if (!lessThanDay || !beforeNineThirty(date)) {
                        date = date.clone().add(date.isoWeekday() >= 5 ? 8 - date.isoWeekday() : 1, 'day');
                    }
                    if (lessThanDay) {
                        date = date.hour(9).minute(30).second(0);
                    }
                }
                data.push(randomBar(date, data.length > 0 ? data[data.length - 1].y : 30));
            }

            return data;
        }



    </script>

</body>

</html>