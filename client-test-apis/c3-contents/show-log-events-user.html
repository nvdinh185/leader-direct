<!-- Đây là trang mẫu cuối cùng ngày 23/01/2021 - cuongdq - có biểu đồ-->
<style>
  .object-center {
    width: 300px;
    height: 300px;
    /* border: 1px solid red; */

    margin: 0px auto;
    text-align: center;
  }

  #cng-chart {
    /* border: 1px solid blue; */
    width: 200px;
    height: 200px;
  }
</style>
<!-- Nhúng đối tượng tổ chức bảng, form tableFlow, ... -->
<script src="./js/dynamic-form/dynamic-form.js"></script>

<!-- Nhúng đối tượng tổ chức lệnh thực thi và tham số input đầu vào -->
<div class="container">
  <form style="max-width: 800px; margin: auto">
    <div class="modal-header"></div>
    <div class="dynamic-form"></div>
    <div class="modal-footer"></div>
  </form>
</div>

<!-- thư viện về chartjs -->
<script src="./js/chart-js/chart.min.js"></script>
<script src="./js/chart-js/utils.js"></script>


<!-- Nội dung kết quả thực thi -->
<div class="container-content">
  <h5 style="text-align: center; text-transform:uppercase;">
    Kết quả:
    <button type="button" class="btn btn-sm btn-danger btn-current-limit"></button>
  </h5>

  <ul class="nav nav-tabs" id="myTab" role="tablist">
    <li class="nav-item">
      <a class="nav-link active" id="home-tab" data-toggle="tab" href="#home" role="tab" aria-controls="home"
        aria-selected="true">Biểu đồ</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="profile-tab" data-toggle="tab" href="#profile" role="tab" aria-controls="profile"
        aria-selected="false">Thống kê</a>
    </li>
  </ul>
  <div class="tab-content" id="myTabContent">
    <div class="tab-pane fade show active" id="home" role="tabpanel" aria-labelledby="home-tab">
      <!-- Đồng chỉnh tâm canh giữa -->
      <div class="object-center">
        <canvas id="cng-chart" width="200" height="200"></canvas>
      </div>
    </div>
    <div class="tab-pane fade" id="profile" role="tabpanel" aria-labelledby="profile-tab">
      <br>
      <!-- Bảng thống kê -->
      <div class="" id="dynamic-table"></div>
    </div>
  </div>

  <p class="col-12 text-left">
    <button type="button" class="btn btn-sm btn-primary btn-read-prev">
      <i class="fa fa-toggle-left icon"></i> Trang trước
    </button>
    <button type="button" class="btn btn-sm btn-success btn-current-page"></button>
    <button type="button" class="btn btn-sm btn-warning btn-read-next">
      Trang sau <i class="fa fa-toggle-right icon"></i>
    </button>
  </p>

  <hr />

  <p class="col-12 text-right">
    <button type="button" class="btn btn-sm btn-rounded btn-info btn-table-import">
      Import <i class="fa fa-cloud-upload icon"></i>
    </button>
    <button type="button" class="btn btn-sm btn-rounded btn-warning btn-table-export">
      <i class="fa fa-cloud-download icon"></i> Export
    </button>
  </p>
  <hr />
  <div class="" id="show-message-status"></div>
</div>

<!-- Nội dung cửa sổ kết quả popup -->
<div class="modal fade" id="popup-api-result" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content text-center">
      <div class="modal-body modal-popup-api-result">
        <div class="container-content">
          <h2 style="text-align: center; text-transform:uppercase;">
            Chi tiết:
            <button type="button" class="btn btn-sm btn-danger btn-current-limit-popup"></button>
          </h2>
          <div class="" id="dynamic-table-popup"></div>
          <hr />
          <p class="col-12 text-right">
            <button type="button" class="btn btn-sm btn-rounded btn-info btn-table-import-popup">
              Import <i class="fa fa-cloud-upload icon"></i>
            </button>
            <button type="button" class="btn btn-sm btn-rounded btn-warning btn-table-export-popup">
              <i class="fa fa-cloud-download icon"></i> Export
            </button>
          </p>
          <hr />
          <div class="" id="show-message-status-popup"></div>
        </div>
        <hr>
        <div class="text-right">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Bỏ qua</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Nội dung cửa sổ xác nhận -->
<div class="modal fade" id="confirm-crud-command" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content text-center">
      <div class="modal-body modal-confirm-crud-command">
        <h5 class="text-uppercase">Xác nhận</h5>
        <hr>
        Bạn muốn...?
        <hr>
        <div class="text-right">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Bỏ qua</button>
          <button type="button" class="btn btn-primary btn-confirm-crud-command">Đồng ý</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Bắt đầu phần code javascript -->
<script>
  // khai báo trong này sẽ không bị lỗi biến đã tồn tại
  $(document).ready(function () {
    hideDefault();
    init();
  });

  function hideDefault() {
    // ẩn đi các nút không cần thiết
    $(".btn-table-import").hide();
    $(".btn-table-export").hide();
    $(".btn-file-upload").hide();
    $(".btn-read-next").hide();
    $(".btn-read-prev").hide();
    $(".btn-current-limit").hide();
    // $(".btn-send-api").hide();
    $(".btn-current-page").hide();
    // $(".btn-params-input").hide();
  }

  // khởi tạo các nút lệnh
  function init() {
    let api, modelParams;
    try {
      api = JSON.parse(API_PARAMS.getKey("api"));
      modelParams = JSON.parse(API_PARAMS.getKey("model-params"));
    } catch { }
    // nếu không có token hoặc hàm api để test thì trở về list-apis
    if (!api || !HOME_PARAMS.token) {
      showToast(
        "warning",
        "Bạn phải đăng nhập trước khi sử dụng chức năng này",
        "toast-top-center",
        2000,
        true
      );

      setTimeout(() => {
        // bắt đầu chuyển sang trang chủ
        window.location.href = "index.html";
      }, 1000);
      return;
    }
    prepairButtons(api);
  }

  // sửa soạn các nút để bấm
  function prepairButtons(api) {
    let items = [
      {
        type: "text",
        name: `Username`,
        // icon: "fa-gears",
        hint: `Tài khoản vd: test.dq@gmail.com`,
        validator: {
          required: true,
          pattern: "[0-9a-z\@\.\*]+",
        },
        key: "username",
        value: ``,
      },
      {
        type: "text",
        name: `wheres`,
        // icon: "fa-gears",
        hint: `Bộ lọc ex:{app:api,ip:{$like:10.*}}`,
        validator: {
          pattern: "^[\{]{1}[a-z0-9\$\*\.\{\}\:]+[\}]{1}$",
        },
        key: "wheres",
        value: ``,
      },
    ];

    let dynamicForm = {
      header: {
        title: api.name,
      },
      items,
      footer: [
        {
          class: "btn-primary",
          name: `${api.method} ${api.api_router}${api.api_function}`,
          icon: "fa-send",
          cmd: api.method,
          next: "VIEW",
          url: `${API_PARAMS.getKey("SERVER_DOMAIN", true) || API_PARAMS.SERVER_DOMAIN
            }${api.api_router}${api.api_function}`,
          token: true,
        },
      ],
    };

    const formDatas = new JSCngDynamicForm();

    // tạo tiêu đề và các nút lệnh trên header
    let htmlHeader = formDatas.createHeader(dynamicForm.header);
    $(".modal-header").html(htmlHeader);

    // tạo các ô nhập liệu
    let htmlForm = formDatas.createFormInput(dynamicForm.items);
    $(".dynamic-form").html(htmlForm);

    // tạo các nút lệnh ở phía dưới
    let htmlFooter = formDatas.createFooter(dynamicForm.footer);
    $(".modal-footer").html(htmlFooter);

    for (let el of dynamicForm.items) {
      let $Input = $(`#${el.key}`);
      $Input.keyup(
        formDatas.debounce(function (event) {
          let value = event.target.value;
          let invalid = false;
          if (el.validator) {
            if (el.validator.required && !$Input.val()) invalid = true;
            if (
              el.validator.min &&
              (!$Input.val() || $Input.val().length < el.validator.min)
            )
              invalid = true;
            if (
              el.validator.max &&
              (!$Input.val() || $Input.val().length > el.validator.max)
            )
              invalid = true;
            if (el.validator.pattern && $Input.val()) {
              let reg = new RegExp(el.validator.pattern);
              if (!reg.test($Input.val())) invalid = true;
            }
          }

          if (!invalid && el.key && el.value !== undefined) {
            $Input.addClass("is-valid");
            $Input.removeClass("is-invalid");
          } else {
            $Input.removeClass("is-valid");
            $Input.addClass("is-invalid");
          }
        }, 500)
      );
    }
    prepairButtonsSubmit(formDatas, dynamicForm);
  }

  function prepairButtonsSubmit(formDatas, dynamicForm) {

    $(".btn-cancel").click((e) => {
      window.history.back();
    });

    const SEND_PARAMS = {};

    // biến ghi nhận đối tượng input lấy được
    let jsonFormData = {};

    $(".btn-send-api").click((e) => {
      jsonFormData = formDatas.getFormData(dynamicForm.items);
      // console.log("data", jsonFormData);
      // ràng buộc tham số phải nhập
      if (!jsonFormData || !jsonFormData.username) {
        showToast(
          "error",
          "Vui lòng kiểm tra lại các trường tham số (username) nhập liệu trước khi gửi",
          "toast-top-center",
          3000,
          true
        );
        return;
      }

      SEND_PARAMS.jsonData = { ...jsonFormData, username: undefined };
      let $this = $(e.target);
      SEND_PARAMS.cmd = $this.attr("command-do"); // lệnh làm gì
      SEND_PARAMS.cNext = $this.attr("command-next"); // nếu thành công thì làm gì tiếp theo
      // SEND_PARAMS.cUrl = $this.attr("command-url"); // đường dẫn tương đối với máy chủ api hoặc tuyệt đối gửi lên máy chủ
      SEND_PARAMS.cToken = $this.attr("command-token"); // có đính kèm token hay không?
      SEND_PARAMS.cUrl = `${API_PARAMS.getKey("SERVER_DOMAIN", true) || API_PARAMS.SERVER_DOMAIN
        }/logs/api/get-events-user/${jsonFormData.username}`
      callSendData(formDatas, SEND_PARAMS);
    });

    // sửa soạn các nút lệnh kế tiếp và xem lùi trang trên csdl
    prepairNextPreviousPageButtons(formDatas, SEND_PARAMS);

    $(".btn-table-export").click((e) => {
      // xuất file excel từ dữ liệu
      if (HOME_PARAMS.sheetDatas.length) {
        // chuyển đổi các trường chứa đối tượng về text trước khi xuất
        let sheetResults = [];
        for (let row of HOME_PARAMS.sheetDatas) {
          if (row && typeof row === "object" && Object.keys(row).length) {
            for (let col in row) {
              row[col] = row[col] && typeof row[col] === "object" ? JSON.stringify(row[col]) : row[col];
            }
            sheetResults.push(row);
          }
        }
        // sắp xếp header chỉ lấy tên cột để xuất ra thôi
        let headers;
        createExcelFile(
          `excel-log-event-username-${API_PARAMS.getTimestamp()}.xlsx`,
          `${(jsonFormData.username || "").replace(/[^\w\s\.\_\-]/gi, '') || "log-event-username"}`,
          sheetResults,
          headers
        );
      }
    });
  }

  function callSendData(formDatas, SEND_PARAMS, page) {
    if (page) SEND_PARAMS.jsonData = { ...SEND_PARAMS.jsonData, page };

    let ajaxSend;
    if (SEND_PARAMS.cmd === "POST") {
      ajaxSend =
        SEND_PARAMS.cUrl.indexOf("http") >= 0
          ? callAjaxPOSTApiAny(
            null,
            SEND_PARAMS.jsonData,
            SEND_PARAMS.cUrl,
            !(SEND_PARAMS.cToken === "true")
          )
          : callAjaxPOSTApiAny(
            SEND_PARAMS.cUrl,
            SEND_PARAMS.jsonData,
            null,
            !(SEND_PARAMS.cToken === "true")
          );
    }

    if (SEND_PARAMS.cmd === "GET") {
      let paramS = Object.keys(SEND_PARAMS.jsonData)
        .map(function (k) {
          return (
            encodeURIComponent(k) +
            "=" +
            encodeURIComponent(SEND_PARAMS.jsonData[k])
          );
        })
        .join("&");
      ajaxSend =
        SEND_PARAMS.cUrl.indexOf("http") >= 0
          ? callAjaxGETApiAny(
            null,
            paramS,
            SEND_PARAMS.cUrl,
            !(SEND_PARAMS.cToken === "true")
          )
          : callAjaxGETApiAny(
            cUrl,
            paramS,
            null,
            !(SEND_PARAMS.cToken === "true")
          );
    }

    if (ajaxSend) {
      // giả lập lệnh đang chạy không cho bấm tiếp theo
      // $("body").addClass("loading");
      fakeLoading(20000, 200);
      ajaxSend
        .then((result) => {
          // $("body").removeClass("loading");
          // console.log("Kết quả", result);
          showToast("success", `Đã gửi lệnh thành công`, null, 3000, true);
          // xét phương thức tiếp theo để xử lý form này
          // CLOSE, RESET, next-page.html
          if (SEND_PARAMS.cNext === "CLOSE") {
            // di chuyển sang trang trước
            //
            window.history.back();
          } else if (SEND_PARAMS.cNext === "VIEW") {
            // hiển thị kết quả lấy được ra màn hình
            showResultApiData(formDatas, result);

          } else if (SEND_PARAMS.cNext === "RESET") {
            // reset trang làm mới lại
            //
            window.location.reload();
          } else if (!SEND_PARAMS.cNext) {
            //
            // chuyển tiếp sang trang khai trong này
            window.location.href = SEND_PARAMS.cNext;
          }
          showHideLoading(false);
        })
        .catch((err) => {
          // $("body").removeClass("loading");
          showApiError(err, true);
          showHideLoading(false);
        });
    }
  }

  function prepairNextPreviousPageButtons(formDatas, SEND_PARAMS) {
    $(".btn-read-next").click(function () {
      let jsonNew = { ...SEND_PARAMS.jsonData };
      callSendData(formDatas, SEND_PARAMS, jsonNew.page + 1);
    });

    $(".btn-read-prev").click(function () {
      let jsonNew = { ...SEND_PARAMS.jsonData };
      callSendData(formDatas, SEND_PARAMS, jsonNew.page - 1);
    });
  }

  // hiển thị kết quả dữ liệu lên form khi query ra
  function showResultApiData(formDatas, result) {
    if (
      result &&
      typeof result === "object"
    ) {

      // đây là kết quả thống kê đã biết là result.results
      if (result.results && !Array.isArray(result.results)) {
        HOME_PARAMS.sheetDatas = [result.results];
        // hiển thị biểu đồ thống kê theo kết quả thu được
        // đây là một kết quả biết trước cấu trúc rồi nhé
        drawChart(result.results);
      } else {
        HOME_PARAMS.sheetDatas = Array.isArray(result) ? [...result] : [result];
      }

      // biến kết quả này sẽ bị append nếu một trang nào đó đang gọi hàm để append nó (như trang content)
      // console.log("Kết quả", HOME_PARAMS.sheetDatas);

      if (HOME_PARAMS.sheetDatas.length) {
        viewTableData(formDatas, HOME_PARAMS.sheetDatas);
      }
      $(".btn-current-page").text(1);
      $(".btn-current-limit").text(HOME_PARAMS.sheetDatas.length);
      // $(".btn-current-page").text(result.page);
      // $(".btn-current-limit").text(result.limit);

      $(".btn-current-page").show();
      $(".btn-current-limit").show();
      $(".btn-table-export").show();

      if (result.page > 1) {
        $(".btn-read-prev").show();
      } else {
        $(".btn-read-prev").hide();
      }
      if (result.next_page > result.page) {
        $(".btn-read-next").show();
      } else {
        $(".btn-read-next").hide();
      }
    } else {
      $(".btn-read-next").hide();
    }
  }

  // thực thi lệnh sau xác nhận
  function doCommandAfterConfirm(cmd, rowId, col_key) {
    const headers = ["commands", "id"];
    const $row = $(`#${rowId}`);
    const jsonData = {};
    // console.log(cmd, rowId, col_key, isNaN(rowId));
    if (isNaN(rowId)) {
      // nếu tìm thấy mã dòng theo table - thì xử lý lệnh theo dòng lấy được trực tiếp trên table
      $row.each(function () {
        const $td = $(this).find("td");
        headers.forEach((header, i) => {
          if (i) jsonData[header] = $td.eq(i).text(); // bỏ qua cột số 1
        });
      });
    } else if (rowId
      && !isNaN(rowId)
      && parseInt(rowId) >= 0
      && col_key
      && HOME_PARAMS.sheetDatas
      && HOME_PARAMS.sheetDatas[parseInt(rowId)]
      && HOME_PARAMS.sheetDatas[parseInt(rowId)][col_key]
    ) {
      // nếu có mã dòng, kiểu số, chuyển đổi được số nguyên dương và tên cột được tìm thấy trong dữ liệu ở bộ nhớ ghi kết quả thì
      // gán một thuộc tính đối tượng của tên cột để hiển thị ra dữ liệu
      jsonData[col_key] = HOME_PARAMS.sheetDatas[parseInt(rowId)][col_key];
    }
    // so sánh dữ liệu soạn thảo và dữ liệu gốc trong chuỗi
    // let jsonOrg = HOME_PARAMS.sheetDatas.find(x=>""+x.id===id);
    // console.log("Xác nhận xóa file", cmd, jsonData);
    // nếu 2 jsonData, jsonOrg này có thay đổi dữ liệu mà lệnh update thì có hiệu lực
    switch (cmd) {
      case "R":
        // đọc lấy nội dung của file này xem để lấy xuống máy luôn
        showToast(
          "success",
          `Đã đọc xong file #${jsonData.id}`,
          "toast-top-center",
          3000,
          true
        );
        break;
      case "U":
        // update 
        showToast(
          "success",
          `Đã CẬP NHẬP file #${jsonData.id} thành công`,
          "toast-top-center",
          3000,
          true
        );
        break;
      case "D":
        // xóa 
        if ($row) $row.detach();
        showToast(
          "success",
          `Đã XÓA file #${jsonData.id} thành công`,
          "toast-top-center",
          3000,
          true
        );
        break;
      case "V":
        // Hiển thị nội dung chi tiết bằng cửa sổ popup bảng chứa đối tượng này 
        // console.log("Cần chi tiết ra", jsonData);
        if (jsonData[col_key] && typeof jsonData[col_key] === "object") {
          // thực hiện popup lên nhé
          // console.log("Cần chi tiết ra", jsonData[col_key]);
          // Đây là kết quả đơn giản, nhỏ, nên cho popup để xem nhé
          showPopupResult(jsonData[col_key], col_key);
        } else {
          showToast(
            "warning",
            `Không có dữ liệu chi tiết để xem nhé`,
            "toast-top-center",
            3000,
            true
          );
        };
        break;
      default:
        break;
    }

    $("#confirm-crud-command").modal("hide");
  }

  // thực thi các lệnh trên dòng
  function doCommandOneRow(thisObj, cmd) {
    const $row = $(thisObj).parents("tr");
    // console.log("lệnh gì, mã số của dòng là bao nhiêu", cmd, $row.attr("id"));
    let msg = cmd === "D" ? `XÓA file này khỏi cloud` : cmd === "U" ? `CẬP NHẬP thông tin lên cloud` : cmd === "R" ? `TẢI file từ cloud xuống` : cmd || ``;
    let htmlForm = `<h5>XÁC NHẬN</h5>
                          <hr>
                          Bạn muốn ${msg}?
                          <hr>
                          <div class="text-right">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Bỏ qua</button>
                            <button type="button" class="btn btn-primary" onclick="doCommandAfterConfirm('${cmd}','${$row.attr("id")}');">Đồng ý</button>
                          </div>`;
    $(".modal-body").html(htmlForm);
    $("#confirm-crud-command").modal("toggle");
    $("#confirm-crud-command").modal("show");
  }

  function doCommandOneCell(thisObj, cmd) {
    // xem cell đang bấm là gì để lấy khóa tham chiếu đúng dòng, cột
    const $cell = $(thisObj).parents("td");
    // console.log("lệnh gì, dòng số, tên cột", cmd, $cell.attr("row_id"), $cell.attr("col_key") );
    let msg = cmd === "V" ? `Xem chi tiết` : cmd || ``;
    let htmlForm = `<h5>XÁC NHẬN</h5>
                      <hr>
                      Bạn muốn ${msg}?
                      <hr>
                      <div class="text-right">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Bỏ qua</button>
                        <button type="button" class="btn btn-primary" onclick="doCommandAfterConfirm('${cmd}','${$cell.attr("row_id")}','${$cell.attr("col_key")}');">Đồng ý</button>
                      </div>`;
    $(".modal-body").html(htmlForm);

    // $("#confirm-crud-command").modal("toggle");
    // $("#confirm-crud-command").modal("show");

    // tự xác nhận nếu không cần bấm đồng ý
    doCommandAfterConfirm(cmd, $cell.attr("row_id"), $cell.attr("col_key"));

  }

  /**
   * Hiển thị nội dung ra bảng
   */
  function viewTableData(formDatas, result) {
    // khai báo các nút lệnh trên từng dòng để khai báo xóa file và chỉnh sửa file
    let buttons = `<button type="button" class="btn btn-sm btn-rounded btn-primary btn-read-one" onclick="doCommandOneRow(this,'R');">
                  <i class="fa fa-download icon"></i> Xem
                  </button>
                  <button type="button" class="btn btn-sm btn-rounded btn-success btn-read-one" onclick="doCommandOneRow(this,'U');">
                  <i class="fa fa-edit icon"></i> Sửa
                  </button>
                  <button type="button" class="btn btn-sm btn-rounded btn-danger btn-read-one" onclick="doCommandOneRow(this,'D');">
                  <i class="fa fa-trash icon"></i> Xóa
                  </button>`;

    // nút lệnh hiển thị nội dung chi tiết nếu kết quả trả về là một đối tượng, chứa thông tin chi tiết hơn
    let viewCommand = `<button type="button" class="btn btn-sm btn-rounded btn-info btn-read-one" onclick="doCommandOneCell(this,'V');">
                          <i class="fa fa-eye icon"></i> ...
                      </button>`

    // định nghĩa các tên trường (cột) cho bảng biết trước để sắp xếp theo ý muốn (nếu có)
    // Để cho phép hiển thị theo thứ tự (1), edit cột đó (2), hoặc ẩn cột đó đi (0), (hoặc chuyển đổi định dạng??? - format??? - viết sau)
    let headers = {
      // id: 1,
      // name: 2,
      // type: 1,
      // size: 1,
      // updated_time: 1,
      // owner: 1,
      // is_private: 2,
      // url_user: 0,
      // url_local: 0,
      // created_time: 0
    };

    // Tạo một bảng dữ liệu theo kết quả lấy được, khai trường "id" làm id của dòng để tham chiếu duy nhất
    let htmlTable = formDatas.arrayObject2HtmlTable(result, headers, null, false, false, null, viewCommand);

    // console.log("Kết quả ", htmlTable);

    if (htmlTable) {
      $("#dynamic-table").html(htmlTable);
      // cập nhập bảng
      $("#table-datatables").DataTable({
        drawCallback: function (settings) {
          $("#table-datatables").reflowTable("update");
        },
        scrollX: "100%",
        scrollY: "60px",  // chỉ 1 dòng nên hiển thị thấp thôi
        ...HOME_PARAMS.DATA_TABLE_PAGING,
      });
      // chỉ hiển thị ở chế độ mobile thôi
      $("#table-datatables").reflowTable({
        autoWidth: false,
      });
      // .mobileMode(true);
    }
  }

  /**
   * Hiển thị cửa sổ chức bảng chi tiết của kết quả
   */
  function showPopupResult(resultDetails, isPopup) {
    // khai cùng đối tượng formDatas để tái sử dụng hàm tạo bảng
    const formDatas = new JSCngDynamicForm();

    // nút lệnh hiển thị nội dung chi tiết nếu kết quả trả về là một đối tượng, chứa thông tin chi tiết hơn
    let viewCommand = `<button type="button" class="btn btn-sm btn-rounded btn-info btn-read-one" onclick="doCommandOneCell(this,'V');">
                          <i class="fa fa-eye icon"></i> ...
                      </button>`

    // định nghĩa các tên trường (cột) cho bảng biết trước để sắp xếp theo ý muốn (nếu có)
    // Để cho phép hiển thị theo thứ tự (1), edit cột đó (2), hoặc ẩn cột đó đi (0), (hoặc chuyển đổi định dạng??? - format??? - viết sau)
    let headers = {};

    // Tạo một bảng dữ liệu theo kết quả lấy được, khai trường "id" làm id của dòng để tham chiếu duy nhất
    let htmlTable = formDatas.arrayObject2HtmlTable(resultDetails, headers, null, false, false, null, viewCommand);
    // console.log("Dữ liệu để hiển thị bảng mới", htmlTable);
    // nếu chi tiết theo bảng mới thì popup, còn nếu chỉ cần chi tiết hiển thị ngay ở trang này thì làm như cũ
    if (htmlTable) {
      if (isPopup) {

        // hiển thị trên trang popup
        $("#dynamic-table-popup").html(`${htmlTable}`);
        // cập nhập bảng
        $("#table-datatables-popup").DataTable({
          drawCallback: function (settings) {
            $("#table-datatables-popup").reflowTable("update");
          },
          scrollX: "100%",
          scrollY: "300px",
          ...HOME_PARAMS.DATA_TABLE_PAGING,
        });
        // chỉ hiển thị ở chế độ mobile thôi
        $("#table-datatables-popup").reflowTable({
          autoWidth: false,
        });
        // .mobileMode(true);

        let htmlForm = `<h5>${isPopup}</h5>
                      ${htmlTable}
                      <div class="text-right">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Bỏ qua</button>
                      </div>`;

        $(".modal-body").html(htmlForm);

        $("#popup-api-result").modal("toggle");
        $("#popup-api-result").modal("show");

      } else {
        // hiển thị chính bảng hiện tại
        $("#dynamic-table").html(htmlTable);
        // cập nhập bảng
        $("#table-datatables").DataTable({
          drawCallback: function (settings) {
            $("#table-datatables").reflowTable("update");
          },
          scrollX: "100%",
          scrollY: "300px",
          ...HOME_PARAMS.DATA_TABLE_PAGING,
        });
        // chỉ hiển thị ở chế độ mobile thôi
        $("#table-datatables").reflowTable({
          autoWidth: false,
        });
        // .mobileMode(true);
        // dữ liệu để xuất ra của bảng đang thấy phải phù hợp với biến thực tế
        HOME_PARAMS.sheetDatas = resultDetails;

      }
    }
  }

  function createExcelFile(fileName, sheetName, sheetResult, headers) {
    const ws = XLSX.utils.json_to_sheet(sheetResult, { headers });
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, sheetName);
    XLSX.writeFile(wb, fileName);
  }
</script>
<!-- Hết code javascript riêng -->

<!-- vẽ chart -->
<script>

  var randomScalingFactor = function () {
    return Math.round(Math.random() * 100);
  };

  window.config = {
    type: 'pie',
    data: {
      datasets: [{
        data: [
          randomScalingFactor(),
          randomScalingFactor(),
          randomScalingFactor(),
          randomScalingFactor(),
          randomScalingFactor(),
        ],
        backgroundColor: [
          window.chartColors.red,
          window.chartColors.orange,
          window.chartColors.yellow,
          window.chartColors.green,
          window.chartColors.blue,
        ],
        label: 'Dataset 1'
      }],
      labels: [
        'Red',
        'Orange',
        'Yellow',
        'Green',
        'Blue'
      ]
    },
    options: {
      responsive: true
    }
  };


  /**
   * Cập nhập lại dữ liệu cho biểu đồ bằng hàm sau
   */
  function updateData(data) {
    // yêu cầu có biểu đồ đã khởi tạo, và dữ liệu hợp lệ
    if (window.cngChart
      && window.config
      && window.config.data
      && window.config.data.datasets) {
      window.config.data.datasets.forEach(function (dataset) {
        dataset.data = data
      });
      window.cngChart.update();
    }
  }

  /**
   * Thêm một bộ thống kê cho biểu đồ
   */
  function addDataset(dataSet) {
    // yêu cầu có biểu đồ đã khởi tạo, và dữ liệu hợp lệ
    if (window.cngChart
      && window.config
      && window.config.data
      && window.config.data.datasets
      && window.config.data.labels
    ) {
      var newDataset = {
        backgroundColor: [],
        data: [],
        label: 'Dataset #' + window.config.data.datasets.length,
      };

      var colorNames = Object.keys(window.chartColors);

      for (var index = 0; index < window.config.data.labels.length; ++index) {
        newDataset.data.push(randomScalingFactor());

        var colorName = colorNames[index % colorNames.length];
        var newColor = window.chartColors[colorName];
        newDataset.backgroundColor.push(newColor);
      }

      window.config.data.datasets.push(newDataset);

      window.cngChart.update();
    }
  }

  /**
   * Xóa bộ thống kê trong biểu đồ
   */
  function removeDataset(idx) {
    // yêu cầu có biểu đồ đã khởi tạo, và dữ liệu hợp lệ
    if (window.cngChart
      && window.config
      && window.config.data
      && window.config.data.datasets
    ) {
      config.data.datasets.splice(idx, 1);
      window.cngChart.update();
    }
  }

  /**
     * Vẽ biểu đồ bằng cấu hình
     */
  function drawChart(result) {

    // console.log("", result);

    // sửa soạn dữ liệu đã biết để ra dữ liệu cấu hình mới
    if (result
      // && Array.isArray(result)
      && typeof result === "object"
      && Object.keys(result).length
    ) {

      // lấy danh sách màu theo id, để gán tuần tự cho thuận lợi
      var colorNames = Object.keys(window.chartColors);

      let data = [];            // dữ liệu cho chart
      let labels = [];          // nhãn cho chart
      let backgroundColor = []; // màu nền cho chart
      for (let event in result) {
        let newColor = colorNames[data.length];
        labels.push(event);
        data.push(parseInt(result[event].count));
        backgroundColor.push(window.chartColors[newColor]);
      }

      window.config = {
        type: 'pie',
        data: {
          datasets: [{
            data,
            backgroundColor: [
              window.chartColors.red,
              window.chartColors.orange,
              window.chartColors.yellow,
              window.chartColors.green,
              window.chartColors.blue,
            ],
            label: 'Số lượng user truy cập'
          }],
          labels
        },
        options: {
          responsive: true
        }
      };
    }

    window.ctx = $("#cng-chart")[0].getContext('2d');
    if (window.ctx && window.config) {
      window.cngChart = new Chart(window.ctx, window.config);
    }
  }

</script>