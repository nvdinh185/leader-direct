<script src="./js/dynamic-form/dynamic-form.js"></script>
<div class="container">
  <form style="max-width: 800px; margin: auto">
    <div class="modal-header"></div>
    <div class="dynamic-form"></div>
    <div class="modal-footer"></div>
  </form>
</div>

<div class="container-content">
  <h2 style="text-align: center">
    DANH SÁCH FILEs THUỘC CÁ NHÂN
    <button type="button" class="btn btn-sm btn-danger btn-current-limit"></button>
  </h2>
  <div class="" id="dynamic-table"></div>

  <div class="" id="dynamic-table-model-detail" class="table-editable"></div>
  <p class="col-12 text-left">
    <button type="button" class="btn btn-sm btn-primary btn-read-prev">
      <i class="fa fa-toggle-left icon"></i> Trang trước
    </button>
    <button type="button" class="btn btn-sm btn-success btn-current-page"></button>
    <button type="button" class="btn btn-sm btn-warning btn-read-next">
      Trang sau <i class="fa fa-toggle-right icon"></i>
    </button>
  </p>
  <hr />
  <p class="col-12 text-right">
    <button type="button" class="btn btn-sm btn-rounded btn-info btn-table-import">
      Import <i class="fa fa-cloud-upload icon"></i>
    </button>
    <button type="button" class="btn btn-sm btn-rounded btn-warning btn-table-export">
      <i class="fa fa-cloud-download icon"></i> Export
    </button>
  </p>
  <hr />
  <div class="" id="show-message-status"></div>
</div>

<div class="modal fade" id="confirm-crud-command" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content text-center">
      <div class="modal-body modal-confirm-crud-command">
        <h5>XÁC NHẬN</h5>
        <hr>
        Bạn muốn xóa file này khỏi cloud?
        <hr>
        <div class="text-right">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Bỏ qua</button>
          <button type="button" class="btn btn-primary btn-confirm-crud-command">Đồng ý</button>
        </div>
      </div>
    </div>
  </div>
</div>


<script>
  // khai báo trong này sẽ không bị lỗi biến đã tồn tại
  $(document).ready(function () {
    hideDefault();
    init();
  });

  function hideDefault() {
    // ẩn đi các nút không cần thiết
    $(".btn-table-import").hide();
    $(".btn-table-export").hide();
    $(".btn-file-upload").hide();
    $(".btn-read-next").hide();
    $(".btn-read-prev").hide();
    $(".btn-current-limit").hide();
    // $(".btn-send-api").hide();
    $(".btn-current-page").hide();
    // $(".btn-params-input").hide();
  }

  // khởi tạo các nút lệnh
  function init() {
    let api, modelParams;
    try {
      api = JSON.parse(API_PARAMS.getKey("api"));
      modelParams = JSON.parse(API_PARAMS.getKey("model-params"));
    } catch { }
    // nếu không có token hoặc hàm api để test thì trở về list-apis
    if (!api || !HOME_PARAMS.token) {
      showToast(
        "warning",
        "Bạn phải đăng nhập trước khi sử dụng chức năng này",
        "toast-top-center",
        2000,
        true
      );

      setTimeout(() => {
        // bắt đầu chuyển sang trang chủ
        window.location.href = "index.html";
      }, 1000);
      return;
    }
    prepairButtons(api);
  }

  // sửa soạn các nút để bấm
  function prepairButtons(api) {
    let items = [
      {
        type: "text",
        name: `Tham số ${api.method}:`,
        icon: "fa-calculator",
        hint: `Nhập tham số cho lệnh ${api.method}`,
        validator: {
          pattern: "^[\{]{1}[a-z0-9'\"\{\}:,\$\\-_]+[\}]{1}$",
        },
        key: "params",
        value: JSON.stringify({
          page: 1,
          limit: 100,
          wheres: { id: { $gte: 1 } },
          sorts: { created_time: -1 },
          fields: {
            id: 1,
            name: 1,
            type: 1,
            size: 1,
            updated_time: 1,
            owner: 1,
            is_private: 1,
          },
        }),
      },
    ];
    let dynamicForm = {
      header: {
        title: "QUẢN TRỊ FILEs CÁ NHÂN",
      },
      items,
      footer: [
        {
          class: "btn-primary",
          name: `Tra cứu file cá nhân ${api.method}`,
          icon: "fa-send",
          cmd: "POST",
          next: "VIEW",
          url: `${API_PARAMS.getKey("SERVER_DOMAIN", true) || API_PARAMS.SERVER_DOMAIN
            }/media/files/post-owner-page`,
          token: true,
        },
      ],
    };

    const formDatas = new JSCngDynamicForm();

    // tạo tiêu đề và các nút lệnh trên header
    let htmlHeader = formDatas.createHeader(dynamicForm.header);
    $(".modal-header").html(htmlHeader);

    // tạo các ô nhập liệu
    let htmlForm = formDatas.createFormInput(dynamicForm.items);
    $(".dynamic-form").html(htmlForm);

    // tạo các nút lệnh ở phía dưới
    let htmlFooter = formDatas.createFooter(dynamicForm.footer);
    $(".modal-footer").html(htmlFooter);

    for (let el of dynamicForm.items) {
      let $Input = $(`#${el.key}`);
      $Input.keyup(
        formDatas.debounce(function (event) {
          let value = event.target.value;
          let invalid = false;
          if (el.validator) {
            if (el.validator.required && !$Input.val()) invalid = true;
            if (
              el.validator.min &&
              (!$Input.val() || $Input.val().length < el.validator.min)
            )
              invalid = true;
            if (
              el.validator.max &&
              (!$Input.val() || $Input.val().length > el.validator.max)
            )
              invalid = true;
            if (el.validator.pattern && $Input.val()) {
              let reg = new RegExp(el.validator.pattern);
              if (!reg.test($Input.val())) invalid = true;
            }
          }

          if (!invalid && el.key && el.value !== undefined) {
            $Input.addClass("is-valid");
            $Input.removeClass("is-invalid");
          } else {
            $Input.removeClass("is-valid");
            $Input.addClass("is-invalid");
          }
        }, 500)
      );
    }
    prepairButtonsSubmit(formDatas, dynamicForm);
  }

  function prepairButtonsSubmit(formDatas, dynamicForm) {

    // let dataClick;
    // $(".btn-confirm-crud-command").click((e) => {
    //   callDeleteRow(dataClick);
    //   $('#confirm-crud-command').modal("hide");
    // });

    // $('#confirm-crud-command').on('show.bs.modal', function (e) {
    //   dataClick = $(e.relatedTarget).attr('data-href');
    //   console.log("Đối tượng đích đang bấm là gì", dataClick);
    // });


    $(".btn-cancel").click((e) => {
      window.history.back();
    });

    const SEND_PARAMS = {};

    $(".btn-send-api").click((e) => {
      let jsonFormData = formDatas.getFormData(dynamicForm.items);

      if (!jsonFormData || !jsonFormData.params) {
        showToast(
          "error",
          "Vui lòng kiểm tra lại các trường nhập liệu trước khi gửi",
          "toast-top-center",
          3000,
          true
        );
        return;
      }

      let jsonData;

      try {
        jsonData = JSON.parse(jsonFormData.params);
      } catch { }

      if (!jsonData) {
        showToast(
          "error",
          "Vui lòng kiểm tra lại chuỗi nhập liệu json data không hợp lệ!",
          "toast-top-center",
          3000,
          true
        );
        return;
      }

      SEND_PARAMS.jsonData = jsonData;
      let $this = $(e.target);
      SEND_PARAMS.cmd = $this.attr("command-do"); // lệnh làm gì
      SEND_PARAMS.cNext = $this.attr("command-next"); // nếu thành công thì làm gì tiếp theo
      SEND_PARAMS.cUrl = $this.attr("command-url"); // đường dẫn tương đối với máy chủ api hoặc tuyệt đối gửi lên máy chủ
      SEND_PARAMS.cToken = $this.attr("command-token"); // có đính kèm token hay không?

      callSendData(formDatas, SEND_PARAMS);
    });

    // sửa soạn các nút lệnh kế tiếp và xem lùi trang trên csdl
    prepairNextPreviousPageButtons(formDatas, SEND_PARAMS);

    $(".btn-table-export").click((e) => {
      // xuất file excel từ dữ liệu
      if (HOME_PARAMS.sheetDatas.length) {
        let headers;
        createExcelFile(
          `excel-user-files-${API_PARAMS.getTimestamp()}.xlsx`,
          `files`,
          HOME_PARAMS.sheetDatas,
          headers
        );
      }
    });
  }

  function callSendData(formDatas, SEND_PARAMS, page) {
    if (page) SEND_PARAMS.jsonData = { ...SEND_PARAMS.jsonData, page };

    let ajaxSend;
    if (SEND_PARAMS.cmd === "POST") {
      ajaxSend =
        SEND_PARAMS.cUrl.indexOf("http") >= 0
          ? callAjaxPOSTApiAny(
            null,
            SEND_PARAMS.jsonData,
            SEND_PARAMS.cUrl,
            !(SEND_PARAMS.cToken === "true")
          )
          : callAjaxPOSTApiAny(
            SEND_PARAMS.cUrl,
            SEND_PARAMS.jsonData,
            null,
            !(SEND_PARAMS.cToken === "true")
          );
    }

    if (SEND_PARAMS.cmd === "GET") {
      let paramS = Object.keys(SEND_PARAMS.jsonData)
        .map(function (k) {
          return (
            encodeURIComponent(k) +
            "=" +
            encodeURIComponent(SEND_PARAMS.jsonData[k])
          );
        })
        .join("&");
      ajaxSend =
        SEND_PARAMS.cUrl.indexOf("http") >= 0
          ? callAjaxGETApiAny(
            null,
            paramS,
            SEND_PARAMS.cUrl,
            !(SEND_PARAMS.cToken === "true")
          )
          : callAjaxGETApiAny(
            cUrl,
            paramS,
            null,
            !(SEND_PARAMS.cToken === "true")
          );
    }

    if (ajaxSend) {
      ajaxSend
        .then((result) => {
          showToast("success", `Đã gửi lệnh thành công`, null, 5000);
          // xét phương thức tiếp theo để xử lý form này
          // CLOSE, RESET, next-page.html
          if (SEND_PARAMS.cNext === "CLOSE") {
            // di chuyển sang trang trước
            //
            window.history.back();
          } else if (SEND_PARAMS.cNext === "VIEW") {
            // hiển thị kết quả lấy được ra màn hình
            showResultApiData(formDatas, result);
          } else if (SEND_PARAMS.cNext === "RESET") {
            // reset trang làm mới lại
            //
            window.location.reload();
          } else if (!SEND_PARAMS.cNext) {
            //
            // chuyển tiếp sang trang khai trong này
            window.location.href = SEND_PARAMS.cNext;
          }
        })
        .catch((err) => {
          showApiError(err, true);
        });
    }
  }

  function prepairNextPreviousPageButtons(formDatas, SEND_PARAMS) {
    $(".btn-read-next").click(function () {
      let jsonNew = { ...SEND_PARAMS.jsonData };
      callSendData(formDatas, SEND_PARAMS, jsonNew.page + 1);
    });

    $(".btn-read-prev").click(function () {
      let jsonNew = { ...SEND_PARAMS.jsonData };
      callSendData(formDatas, SEND_PARAMS, jsonNew.page - 1);
    });
  }

  // hiển thị kết quả dữ liệu lên form
  function showResultApiData(formDatas, result) {
    if (
      result &&
      result.page &&
      result.limit &&
      result.data &&
      result.data.length
    ) {
      HOME_PARAMS.sheetDatas = result.data;

      if (HOME_PARAMS.sheetDatas.length) {
        viewTableData(formDatas, HOME_PARAMS.sheetDatas);
      }
      $(".btn-current-page").text(result.page);
      $(".btn-current-limit").text(result.limit);

      $(".btn-current-page").show();
      $(".btn-current-limit").show();
      $(".btn-table-export").show();

      if (result.page > 1) {
        $(".btn-read-prev").show();
      } else {
        $(".btn-read-prev").hide();
      }
      if (result.next_page > result.page) {
        $(".btn-read-next").show();
      } else {
        $(".btn-read-next").hide();
      }
    } else {
      $(".btn-read-next").hide();
    }
  }

  // thực thi lệnh sau xác nhận
  function doCommandAfterConfirm(cmd, rowId) {
    const headers = ["commands", "id"];
    const $row = $(`#${rowId}`);
    const jsonData = {};
    $row.each(function () {
      const $td = $(this).find("td");
      headers.forEach((header, i) => {
        if (i) jsonData[header] = $td.eq(i).text(); // bỏ qua cột số 1
      });
    });
    // so sánh dữ liệu soạn thảo và dữ liệu gốc trong chuỗi
    // let jsonOrg = HOME_PARAMS.sheetDatas.find(x=>""+x.id===id);
    // console.log("Xác nhận xóa file", cmd, jsonData);
    // nếu 2 jsonData, jsonOrg này có thay đổi dữ liệu mà lệnh update thì có hiệu lực
    switch (cmd) {
      case "R":
        // đọc lấy nội dung của file này xem để lấy xuống máy luôn
        showToast(
          "success",
          `Đã đọc xong file #${jsonData.id}`,
          "toast-top-center",
          3000,
          true
        );
        break;
      case "U":
        // update 
        showToast(
          "success",
          `Đã CẬP NHẬP file #${jsonData.id} thành công`,
          "toast-top-center",
          3000,
          true
        );
        break;
      case "D":
        // xóa 
        $row.detach();
        showToast(
          "success",
          `Đã XÓA file #${jsonData.id} thành công`,
          "toast-top-center",
          3000,
          true
        );
        break;
      default:
        break;
    }

    $("#confirm-crud-command").modal("hide");
  }

  // thực thi các lệnh trên dòng
  function doCommandOneRow(thisObj, cmd) {

    const $row = $(thisObj).parents("tr");
    let msg = cmd === "D" ? `XÓA file này khỏi cloud` : cmd === "U" ? `CẬP NHẬP thông tin lên cloud` : cmd === "R" ? `TẢI file từ cloud xuống` : cmd || ``;
    let htmlForm = `<h5>XÁC NHẬN</h5>
                          <hr>
                          Bạn muốn ${msg}?
                          <hr>
                          <div class="text-right">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Bỏ qua</button>
                            <button type="button" class="btn btn-primary" onclick="doCommandAfterConfirm('${cmd}','${$row.attr("id")}');">Đồng ý</button>
                          </div>`;
    $(".modal-body").html(htmlForm);
    $("#confirm-crud-command").modal("toggle");
    $("#confirm-crud-command").modal("show");
  }

  /**
   * Hiển thị nội dung ra bảng
   */
  function viewTableData(formDatas, result) {
    // khai báo các nút lệnh trên từng dòng để khai báo xóa file và chỉnh sửa file
    let buttons = `<button type="button" class="btn btn-sm btn-rounded btn-primary btn-read-one" onclick="doCommandOneRow(this,'R');">
                  <i class="fa fa-download icon"></i> Xem
                  </button>
                  <button type="button" class="btn btn-sm btn-rounded btn-success btn-read-one" onclick="doCommandOneRow(this,'U');">
                  <i class="fa fa-edit icon"></i> Sửa
                  </button>
                  <button type="button" class="btn btn-sm btn-rounded btn-danger btn-read-one" onclick="doCommandOneRow(this,'D');">
                  <i class="fa fa-trash icon"></i> Xóa
                  </button>`;

    let headers = {
      id: 1,
      name: 2,
      type: 1,
      size: 1,
      updated_time: 1,
      owner: 1,
      is_private: 2,
      url_user: 0,
      url_local: 0,
      created_time: 0
    };

    // Tạo một bảng dữ liệu theo kết quả lấy được, khai trường "id" làm id của dòng để tham chiếu duy nhất
    let htmlTable = formDatas.arrayObject2HtmlTable(result, headers, buttons, false, false, "id");
    if (htmlTable) {
      $("#dynamic-table").html(htmlTable);
      // cập nhập bảng
      $("#table-datatables").DataTable({
        drawCallback: function (settings) {
          $("#table-datatables").reflowTable("update");
        },
        scrollX: "100%",
        scrollY: "300px",
        ...HOME_PARAMS.DATA_TABLE_PAGING,
      });
      // chỉ hiển thị ở chế độ mobile thôi
      $("#table-datatables").reflowTable({
        autoWidth: false,
      });
      // .mobileMode(true);
    }
  }

  function createExcelFile(fileName, sheetName, sheetResult, headers) {
    const ws = XLSX.utils.json_to_sheet(sheetResult, { headers });
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, sheetName);
    XLSX.writeFile(wb, fileName);
  }
</script>