<script src="./js/dynamic-form/dynamic-form.js"></script>

<script type="text/javascript"></script>

<div class="container">
  <form style="max-width: 500px; margin: auto">
    <div class="modal-header"></div>
    <div class="dynamic-form"></div>
    <div class="modal-footer"></div>
  </form>
</div>

<div class="overlay">
  <div class="progress centered">
    <div class="progress-bar"></div>
  </div>
</div>

<script type="text/javascript">
  $(document).ready(function () {
    let items = [
      {
        type: "text",
        // name: "Username",
        icon: "fa-user",
        hint:
          "Nhập tài khoản đăng nhập của bạn là số điện thoại, email hoặc tài khoản ldap@mobifone.vn",
        validator: {
          required: true,
          pattern:
            "(^[0]{1}[123456789]{1}[0-9]{8}$)|((^[a-zA-Z]{1}[a-zA-Z0-9\-\_\.])+@[a-zA-Z\_]+?(\.[a-zA-Z]{2,6})+)|((^[a-zA-Z]{1}[a-zA-Z0-9\-\_\.])+)",
        },
        key: "username",
        value: "",
      },

      {
        type: "password",
        // name: "Password",
        icon: "fa-key",
        hint: "Nhập mật khẩu của bạn",
        validator: { required: true },
        key: "password",
        value: "",
      },
      {
        type: "select",
        // name: "Device",
        icon: "fa-clock-o",
        hint: "Chọn loại thiết bị (liên quan số ngày hiệu lực)",
        key: "expired",
        validator: { required: true, pattern: "^[0-9]*$" },
        value: "1",
        options: [
          {
            value: "",
            name: "Chọn loại thiết bị",
          },
          {
            value: "1",
            name: "Thiết bị dùng chung (mỗi lần sử dụng phải đăng nhập)",
          },
          {
            value: "365",
            name:
              "Thiết bị thuộc cá nhân (ghi nhớ phiên làm việc để không phải đăng nhập nhiều lần",
          },
        ],
      },
    ];

    let dynamicForm = {
      header: {
        title: `ĐĂNG NHẬP hoặc
              <span id="register-link" class="text-right">
                <a
                  href="#!"
                  onclick="doSomeThing('./home-contents/show-register.html')"
                  class="text-info btn-register"
                  >Đăng ký</a
                >
              </span>`,
        color: "text-info",
      },
      items,
      footer: [
        {
          class: "btn-secondary",
          name: "Bỏ qua",
          icon: "fa-close",
          cmd: "CLOSE",
        },
        {
          class: "btn-primary",
          name: "Đăng nhập",
          icon: "fa-send",
          cmd: "DO-ANY",
          next: "RESET",
          token: true,
        },
      ],
    };

    const formDatas = new JSCngDynamicForm();

    // tạo tiêu đề và các nút lệnh trên header
    let htmlHeader = formDatas.createHeader(dynamicForm.header);
    $(".modal-header").html(htmlHeader);

    // tạo các ô nhập liệu
    let htmlForm = formDatas.createFormInput(dynamicForm.items);
    $(".dynamic-form").html(htmlForm);

    // tạo các nút lệnh ở phía dưới
    let htmlFooter = formDatas.createFooter(dynamicForm.footer);
    $(".modal-footer").html(htmlFooter);

    for (let el of dynamicForm.items) {
      let $Input = $(`#${el.key}`);
      $Input.keyup(
        formDatas.debounce(function (event) {
          let value = event.target.value;
          let invalid = false;
          if (el.validator) {
            if (el.validator.required && !$Input.val()) invalid = true;
            if (
              el.validator.min &&
              (!$Input.val() || $Input.val().length < el.validator.min)
            )
              invalid = true;
            if (
              el.validator.max &&
              (!$Input.val() || $Input.val().length > el.validator.max)
            )
              invalid = true;
            if (el.validator.pattern && $Input.val()) {
              let reg = new RegExp(el.validator.pattern);
              if (!reg.test($Input.val())) invalid = true;
            }
          }

          if (!invalid && el.key && el.value !== undefined) {
            $Input.addClass("is-valid");
            $Input.removeClass("is-invalid");
          } else {
            $Input.removeClass("is-valid");
            $Input.addClass("is-invalid");
          }
        }, 500)
      );
    }

    $(".btn-cancel").click((e) => {
      window.history.back();
    });

    $(".btn-send-api").click((e) => {
      let jsonData = formDatas.getFormData(dynamicForm.items);
      if (!jsonData) {
        showToast(
          "error",
          "Vui lòng kiểm tra lại các trường nhập liệu trước khi gửi",
          "toast-top-center",
          3000,
          true
        );
        return;
      }

      let $this = $(e.target);
      let cmd = $this.attr("command-do"); // lệnh làm gì
      let cNext = $this.attr("command-next"); // nếu thành công thì làm gì tiếp theo
      let cUrl = $this.attr("command-url"); // đường dẫn tương đối với máy chủ api hoặc tuyệt đối gửi lên máy chủ
      let cToken = $this.attr("command-token"); // có đính kèm token hay không?

      let ajaxSend;
      if (cmd === "POST") {
        ajaxSend =
          cUrl.indexOf("http") >= 0
            ? callAjaxPOSTApiAny(null, jsonData, cUrl, !(cToken === "true"))
            : callAjaxPOSTApiAny(cUrl, jsonData, null, !(cToken === "true"));
      }

      if (cmd === "GET") {
        let paramS = Object.keys(jsonData)
          .map(function (k) {
            return (
              encodeURIComponent(k) + "=" + encodeURIComponent(jsonData[k])
            );
          })
          .join("&");
        ajaxSend =
          cUrl.indexOf("http") >= 0
            ? callAjaxGETApiAny(null, paramS, cUrl, !(cToken === "true"))
            : callAjaxGETApiAny(cUrl, paramS, null, !(cToken === "true"));
      }

      // làm bất cứ thứ gì ta muốn ở đây
      // yêu cầu thực hiện kiểu promise để tận dụng phiên kiểm tra kết quả ở phía sau
      // không phải sửa chữa thêm
      if (cmd == "DO-ANY") {
        if (
          !REG_PARAMS.NUMBER_REG.test(jsonData.username) &&
          !REG_PARAMS.EMAIL_REG.test(jsonData.username)
        ) {
          // đây là user kiểu LDAP nên tự bổ sung @mobifone để xác minh
          jsonData.username += "@mobifone.vn";
          showToast(
            "warning",
            `Bạn đang đăng nhập tài khoản LDAP của Mobifone ${username}`,
            "toast-top-right",
            1000
          );
        }

        ajaxSend = HOME_PARAMS.client
          .loginByUser(
            jsonData.username,
            null,
            jsonData.password,
            jsonData.expired || 1
          )
          .then((tokenData) => {
            if (tokenData.userInfo) {
              API_PARAMS.saveKey("token", tokenData.token, true);
              API_PARAMS.saveKey(
                "userInfo",
                JSON.stringify(tokenData.userInfo),
                true
              );
              return {
                message: `Login thành công với username=${jsonData.username}`,
              };
            }
            throw "Đăng nhập không thành công, vui lòng kiểm tra lại username hoặc password";
          });
      }

      if (ajaxSend) {
        fakeLoading(20000, 100);
        showToast("info", "Đang xác minh thông tin tài khoản","toast-top-right",1000);
        ajaxSend
          .then((result) => {
            showHideLoading(false);

            showToast(
              "success",
              result.message || `Thực thi thành công!`,
              "toast-top-right",
              3000
            );

            setTimeout(() => {
              // xét phương thức tiếp theo để xử lý form này
              // CLOSE, RESET, next-page.html
              if (cNext === "CLOSE") {
                // di chuyển sang trang trước
                //
                window.history.back();
              } else if (cNext === "RESET") {
                // reset trang làm mới lại
                //
                window.location.reload();
              } else if (!cNext) {
                //
                // chuyển tiếp sang trang khai trong này
                window.location.href = cNext;
              }
            }, 1000);
          })
          .catch((err) => {
            showHideLoading(false);
            showApiError(err);
          });
      }
    });
  });
</script>
