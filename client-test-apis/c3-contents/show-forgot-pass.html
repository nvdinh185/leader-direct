<link rel="stylesheet" href="./css/forgot-pass.css" />
<div id="sc-password">
  <h1>BẠN THẬT SỰ QUÊN MẬT KHẨU?</h1>
  <span id="view-message" style="color: green; display: none"
    >tài khoản đăng nhập</span
  >
  <div class="sc-container">
    <input
      type="text"
      name="phoneOrEmail"
      placeholder="Nhập số điện thoại hoặc email của bạn"
    />

    <p id="error-pass" style="color: red; display: none">Lỗi gửi ajax</p>

    <input
      type="button"
      name="send"
      id="send"
      value="Gửi yêu cầu tạo lại mật khẩu"
    />
  </div>
</div>

<script type="text/javascript">
  // delay để kiểm tra kết quả
  function debounce(fn, delay) {
    return (args) => {
      clearTimeout(fn.id);
      fn.id = setTimeout(() => {
        fn.call(this, args);
      }, delay);
    };
  }

  // [name="ElementNameHere"]
  $("#send").click(function () {
    let username = $('[name="phoneOrEmail"]').val();

    if (
      !username ||
      (!REG_PARAMS.VN_MOBILE_NUMBER_REG.test(username) &&
        !REG_PARAMS.EMAIL_REG.test(username))
    ) {
      $("#error-pass").html(
        "Bạn phải nhập đẩy đủ tên tài khoản đăng nhập của bạn đã đăng ký để chúng tôi xác minh"
      );
      $("#error-pass").show();

      showToast(
        "warning",
        `Vui lòng nhập đầy đủ tên tài khoản để chúng tôi xác minh tính hợp lệ tài khoản của bạn`,
        null,
        5000
      );

      return;
    }

    let jsonData = {
      username,
      cmd: "RESET-PASS",
    };

    $("#error-pass").html(`Vui lòng đợi nhé ...`);
    $("#error-pass").show();

    let url = `${
      API_PARAMS.getKey("SERVER_SOCKET", true) || API_PARAMS.SERVER_SOCKET
    }${API_PARAMS.FORGOT_PASS}`;
    let token = API_PARAMS.getToken();

    //fake kiểu loading
    fakeLoading(5000, 100);

    callAjaxPOSTApiAny("", jsonData, url)
      .then((result) => {
        $("#error-pass").html(
          result.message +
            `<br><br>Vui lòng kiểm tra trên thiết bị nhận ${
              username
            } XÁC NHẬN để hoàn thành việc reset mật khẩu này nhé`
        );

        showToast(
          "success",
          result.message +
            `<br><br>Vui lòng kiểm tra trên thiết bị nhận ${
              username
            } XÁC NHẬN việc tạo lại mật khẩu để hoàn thành việc quên mật khẩu của bạn`,
          null,
          5000
        );

        showHideLoading(false);

        // đợi 1 giây để quay về trang chủ như login
        setTimeout(() => {
          // bắt đầu chuyển sang trang chủ
          window.location.href = "index.html";
        }, 3000);
      })
      .catch((err) => {
        if (
          !err.responseJSON ||
          !err.responseJSON.message ||
          typeof err.responseJSON.error === "object"
        )
          console.log("Lỗi reset pass", err);

        $("#error-pass").html(
          err && err.responseJSON
            ? err.responseJSON.message
            : "Lỗi reset mật khẩu, vui lòng xem cảnh báo"
        );
        $("#error-pass").show();

        showToast(
          "error",
          err && err.responseJSON
            ? err.responseJSON.message
            : JSON.stringify(err),
          "toast-top-right",
          5000,
          true
        );
        showHideLoading(false);

        setTimeout(() => {
          // bắt đầu chuyển sang trang chủ
          window.location.href = "index.html";
        }, 3000);

      });
  });
</script>
