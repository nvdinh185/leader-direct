<!DOCTYPE html>
<html>

<head>
  <title>socket.cng.vn-4.0</title>
  <link rel="icon" type="image/png" href="./icon/favicon.png" />
  <meta charset="utf-8" />

  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />

  <!-- Lấy toàn bộ icon để vẽ cho nút -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />

  <link rel="stylesheet" href="./css/bootstrap-4.3.1-min.css" />
  <!-- Nhúng thư viện socket vào đây để login bằng socket -->
  <script src="./js/www.client.socket.login.js"></script>

  <!-- Khai báo các biến dùng chung ở đây yêu cầu load lại file này thì khai báo tên khác mỗi lần install -->
  <script src="./js/config/params-home-socket.cng.vn.js"></script>

  <script src="./js/jquery.min.js"></script>
  <script src="./js/popper-1.14.3-min.js"></script>
  <script src="./js/bootstrap-4.3.1-min.js"></script>

  <script src="./js/utils/secret/md5.js"></script>

  <link rel="stylesheet" href="./css/loading-style.css" />

  <!-- tableEditable -->
  <link href="./css/reflow-table.css" rel="stylesheet" type="text/css" />
  <link href="./css/datatables.min.css" rel="stylesheet" type="text/css" />
  <script src="./js/get-query-param.js"></script>
  <script src="./js/reflow-table.js"></script>
  <script type="text/javascript" src="./js/datatables.min.js"></script>

  <!-- Cách dùng xlsx.full.min.js https://github.com/SheetJS/sheetjs-->
  <script src="./js/utils/excel/sheet-js.min.js"></script>

  <!-- https://www.jqueryscript.net/demo/Highly-Customizable-jQuery-Toast-Message-Plugin-Toastr/ -->
  <link href="./css/toastr.min.css" rel="stylesheet" type="text/css" />
  <script src="./js/toastr.min.js"></script>

  <!-- Chỉ sử dụng css riêng đè các css mặt định -->
  <link href="./css/main.css" rel="stylesheet" type="text/css" />
</head>
<script>
  // tài liệu sẵn sàng
  $(document).ready(function () {
    $("#alert-executed").hide();
    $("#header-nav").load("./c3-headers/dynamic-nav-bar.html");
    $("#content-nav").load("./c3-contents/show-content.html");
    $("#footer-nav").load("./c3-footers/footer.html");
    setTimeout(() => {
      init();
      // thiết lập chế độ ban ngày và ban đêm cho thanh menu trên cùng
      if (API_PARAMS.getDateNight()) {
        $(".navbar").removeClass("navbar-dark bg-dark");
        $(".navbar").addClass("navbar-light bg-primary");
      } else {
        $(".navbar").removeClass("navbar-light bg-primary");
        $(".navbar").addClass("navbar-light bg-dark");
      }
    }, 1000);

    $(".carousel-item").click((e) => {
      let $this = $(e.target);
      let cmd = $this.attr("command-link"); // lệnh làm gì
      if (cmd) {
        window.open(cmd);
      }
    });
  });
</script>

<!-- Các hàm sử dụng chung tô điểm cho web đẹp và hỗ trợ lập trình viên kiểm soát lỗi  -->
<script src="./js/main/1.www-notify-pretty.js"></script>

<!-- các hàm ajax dùng chung gọi kiểu promise 
    nhúng kiểu file rời sẽ bị lỗi này:
    [Deprecation] Synchronous XMLHttpRequest on the main thread is deprecated because of its detrimental effects to the end user's experience. For more help, check https://xhr.spec.whatwg.org/.
   -->
<script src="./js/main/2.http-get-post.js"></script>

<!-- các lệnh khởi tạo và thực thi trên thanh nav -->
<script src="./js/main/3.do-command-on-nav-bar.js"></script>

<!-- các hàm tạo api tự động trêm menu -->
<script src="./js/main/4.call-dynamic-apis.js"></script>

<style>
  .container {
    padding-top: 10px;
  }

  .img-slider {
    height: 200px;
    background-repeat: no-repeat;
    background-position: center center;
    background-size: cover;
  }

  textarea.textarea-autosize {
    height: 2.25rem;
    min-height: 2.25rem;
    resize: none;
    overflow-y: hidden;
  }

  textarea.textarea-autosize.form-control-lg {
    height: 3.75rem;
    min-height: 3.75rem;
  }

  textarea.textarea-autosize.form-control-sm {
    height: 2rem;
    min-height: 2rem;
  }
</style>

<body>

  <!-- Bắt đầu phần content -->
  <script src="./js/dynamic-form/dynamic-form.js"></script>
  <script src="./js/text-area-autosize.js"></script>
  <div class="container">
    <form style="max-width: 800px; margin: auto">
      <div class="modal-header"></div>
      <div class="dynamic-form">
        <div class="">
          <textarea class="form-control textarea-autosize" id="xxx" rows="3" placeholder="Đây là cái gì"></textarea>
          <div class="invalid-feedback">hhu</div>
        </div>
      </div>
      <div class="modal-footer"></div>
    </form>
  </div>

  <div class="container-content">
    <h2 style="text-align: center; text-transform:uppercase;">
      Kết quả:
      <button type="button" class="btn btn-sm btn-danger btn-current-limit"></button>
    </h2>
    <div class="" id="dynamic-table"></div>

    <div class="" id="dynamic-table-model-detail" class="table-editable"></div>
    <p class="col-12 text-left">
      <button type="button" class="btn btn-sm btn-primary btn-read-prev">
        <i class="fa fa-toggle-left icon"></i> Trang trước
      </button>
      <button type="button" class="btn btn-sm btn-success btn-current-page"></button>
      <button type="button" class="btn btn-sm btn-warning btn-read-next">
        Trang sau <i class="fa fa-toggle-right icon"></i>
      </button>
    </p>
    <hr />
    <p class="col-12 text-right">
      <button type="button" class="btn btn-sm btn-rounded btn-info btn-table-import">
        Import <i class="fa fa-cloud-upload icon"></i>
      </button>
      <button type="button" class="btn btn-sm btn-rounded btn-warning btn-table-export">
        <i class="fa fa-cloud-download icon"></i> Export
      </button>
    </p>
    <hr />
    <div class="" id="show-message-status"></div>
  </div>

  <div class="modal fade" id="confirm-crud-command" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content text-center">
        <div class="modal-body modal-confirm-crud-command">
          <h5 class="text-uppercase">Xác nhận</h5>
          <hr>
          Bạn muốn...?
          <hr>
          <div class="text-right">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Bỏ qua</button>
            <button type="button" class="btn btn-primary btn-confirm-crud-command">Đồng ý</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Hết phần content body -->

  <div class="overlay">
    <div class="progress centered">
      <div class="progress-bar"></div>
    </div>
  </div>

  <script src="./js/main/5.verify-socket-client.js"></script>
</body>

</html>

<!-- Bắt đầu phần code javascript -->
<script>
  // khai báo trong này sẽ không bị lỗi biến đã tồn tại
  $(document).ready(function () {
    hideDefault();
    init();
  });

  function hideDefault() {
    // ẩn đi các nút không cần thiết
    $(".btn-table-import").hide();
    $(".btn-table-export").hide();
    $(".btn-file-upload").hide();
    $(".btn-read-next").hide();
    $(".btn-read-prev").hide();
    $(".btn-current-limit").hide();
    // $(".btn-send-api").hide();
    $(".btn-current-page").hide();
    // $(".btn-params-input").hide();
  }

  // khởi tạo các nút lệnh
  function init() {
    let api, modelParams;
    try {
      api = JSON.parse(API_PARAMS.getKey("api"));
      modelParams = JSON.parse(API_PARAMS.getKey("model-params"));
    } catch { }
    // nếu không có token hoặc hàm api để test thì trở về list-apis
    if (!api || !HOME_PARAMS.token) {
      showToast(
        "warning",
        "Bạn phải đăng nhập trước khi sử dụng chức năng này",
        "toast-top-center",
        2000,
        true
      );

      setTimeout(() => {
        // bắt đầu chuyển sang trang chủ
        window.location.href = "index.html";
      }, 1000);
      return;
    }
    prepairButtons(api);
  }

  // sửa soạn các nút để bấm
  function prepairButtons(api) {
    let items = [
      // {
      //   type: "select",
      //   name: ":model_name",
      //   icon: "fa-database",
      //   hint: "Lựa chọn một mô hình giao tiếp csdl (*)",
      //   key: "model_name",
      //   validator: { required: true },
      //   value: "",
      //   options: [
      //     {
      //       value: "",
      //       name: "Chọn mô hình",
      //     },
      //     {
      //       value: "granted_users",
      //       name: "CSDL phân quyền api (Sqlite3)",
      //     },
      //     {
      //       value: "media_files",
      //       name: "Quản lý files (Sqlite3)",
      //     },
      //     {
      //       value: "cdkh_c3",
      //       name: "Oracle CDKH (Oracle 12C)",
      //     },
      //     {
      //       value: "mongo_69",
      //       name: "Mongodb 150.69",
      //     },
      //     {
      //       value: "mongo_3553",
      //       name: "Mongodb 50.53/35",
      //     },
      //   ],
      // },
      {
        type: "textarea",
        name: `Mệnh đề select/read`,
        icon: "fa-gears",
        hint: `Lệnh sql ví dụ: select * from dual where rownum<10`,
        validator: {
          required: true,
          pattern: "[a-zA-Z0-9'\*\"\(\)=,\\-_%]+",
        },
        key: "script",
        value: `select * 
  from dual
  `,
      },
      {
        type: "select",
        name: "Số lượng bản ghi tối đa",
        icon: "fa-database",
        hint: "Lựa chọn lấy tối đa số lượng bản ghi tránh truy vấn full tablescan",
        key: "rownum",
        validator: { required: true },
        value: "10",
        options: [
          {
            value: "10",
            name: "10 dòng",
          },
          {
            value: "50",
            name: "50 dòng",
          },
          {
            value: "100",
            name: "100 dòng",
          },
          {
            value: "250",
            name: "250 dòng",
          },
          {
            value: "500",
            name: "500 dòng",
          },
          {
            value: "1000",
            name: "1000 dòng",
          },
          {
            value: "2000",
            name: "2000 dòng",
          }
        ],
      },
    ];

    let dynamicForm = {
      header: {
        title: "Thực thi mệnh đề select/read trong mô hình CRUD",
      },
      items,
      footer: [
        {
          class: "btn-primary",
          name: `Chạy lệnh truy vấn csdl ${api.method}`,
          icon: "fa-send",
          cmd: "POST",
          next: "VIEW",
          url: `${API_PARAMS.getKey("SERVER_DOMAIN", true) || API_PARAMS.SERVER_DOMAIN
            }/media/models/run-script/cdkh_c3`,
          token: true,
        },
      ],
    };

    const formDatas = new JSCngDynamicForm();

    // tạo tiêu đề và các nút lệnh trên header
    let htmlHeader = formDatas.createHeader(dynamicForm.header);
    $(".modal-header").html(htmlHeader);

    // tạo các ô nhập liệu
    let htmlForm = formDatas.createFormInput(dynamicForm.items);
    $(".dynamic-form").html(htmlForm);
    $(".textarea-autosize").textareaAutoSize();

    // tạo các nút lệnh ở phía dưới
    let htmlFooter = formDatas.createFooter(dynamicForm.footer);
    $(".modal-footer").html(htmlFooter);

    for (let el of dynamicForm.items) {
      let $Input = $(`#${el.key}`);
      $Input.keyup(
        formDatas.debounce(function (event) {
          let value = event.target.value;
          let invalid = false;
          if (el.validator) {
            if (el.validator.required && !$Input.val()) invalid = true;
            if (
              el.validator.min &&
              (!$Input.val() || $Input.val().length < el.validator.min)
            )
              invalid = true;
            if (
              el.validator.max &&
              (!$Input.val() || $Input.val().length > el.validator.max)
            )
              invalid = true;
            if (el.validator.pattern && $Input.val()) {
              let reg = new RegExp(el.validator.pattern);
              if (!reg.test($Input.val())) invalid = true;
            }
          }

          if (!invalid && el.key && el.value !== undefined) {
            $Input.addClass("is-valid");
            $Input.removeClass("is-invalid");
          } else {
            $Input.removeClass("is-valid");
            $Input.addClass("is-invalid");
          }
        }, 500)
      );
    }
    prepairButtonsSubmit(formDatas, dynamicForm);
  }

  function prepairButtonsSubmit(formDatas, dynamicForm) {

    // let dataClick;
    // $(".btn-confirm-crud-command").click((e) => {
    //   callDeleteRow(dataClick);
    //   $('#confirm-crud-command').modal("hide");
    // });

    // $('#confirm-crud-command').on('show.bs.modal', function (e) {
    //   dataClick = $(e.relatedTarget).attr('data-href');
    //   console.log("Đối tượng đích đang bấm là gì", dataClick);
    // });


    $(".btn-cancel").click((e) => {
      window.history.back();
    });

    const SEND_PARAMS = {};

    $(".btn-send-api").click((e) => {
      let jsonFormData = formDatas.getFormData(dynamicForm.items);

      // console.log("data", jsonFormData);

      if (!jsonFormData || !jsonFormData.script || !jsonFormData.rownum) {
        showToast(
          "error",
          "Vui lòng kiểm tra lại các trường tham số (rownum/script) nhập liệu trước khi gửi",
          "toast-top-center",
          3000,
          true
        );
        return;
      }

      SEND_PARAMS.jsonData = { script: `select * from (${jsonFormData.script}) where rownum<=${jsonFormData.rownum}` };
      let $this = $(e.target);
      SEND_PARAMS.cmd = $this.attr("command-do"); // lệnh làm gì
      SEND_PARAMS.cNext = $this.attr("command-next"); // nếu thành công thì làm gì tiếp theo
      SEND_PARAMS.cUrl = $this.attr("command-url"); // đường dẫn tương đối với máy chủ api hoặc tuyệt đối gửi lên máy chủ
      SEND_PARAMS.cToken = $this.attr("command-token"); // có đính kèm token hay không?

      callSendData(formDatas, SEND_PARAMS);
    });

    // sửa soạn các nút lệnh kế tiếp và xem lùi trang trên csdl
    prepairNextPreviousPageButtons(formDatas, SEND_PARAMS);

    $(".btn-table-export").click((e) => {
      // xuất file excel từ dữ liệu
      if (HOME_PARAMS.sheetDatas.length) {
        let headers;
        createExcelFile(
          `excel-cdkh-c3-script-${API_PARAMS.getTimestamp()}.xlsx`,
          `files`,
          HOME_PARAMS.sheetDatas,
          headers
        );
      }
    });
  }

  function callSendData(formDatas, SEND_PARAMS, page) {
    if (page) SEND_PARAMS.jsonData = { ...SEND_PARAMS.jsonData, page };

    let ajaxSend;
    if (SEND_PARAMS.cmd === "POST") {
      ajaxSend =
        SEND_PARAMS.cUrl.indexOf("http") >= 0
          ? callAjaxPOSTApiAny(
            null,
            SEND_PARAMS.jsonData,
            SEND_PARAMS.cUrl,
            !(SEND_PARAMS.cToken === "true")
          )
          : callAjaxPOSTApiAny(
            SEND_PARAMS.cUrl,
            SEND_PARAMS.jsonData,
            null,
            !(SEND_PARAMS.cToken === "true")
          );
    }

    if (SEND_PARAMS.cmd === "GET") {
      let paramS = Object.keys(SEND_PARAMS.jsonData)
        .map(function (k) {
          return (
            encodeURIComponent(k) +
            "=" +
            encodeURIComponent(SEND_PARAMS.jsonData[k])
          );
        })
        .join("&");
      ajaxSend =
        SEND_PARAMS.cUrl.indexOf("http") >= 0
          ? callAjaxGETApiAny(
            null,
            paramS,
            SEND_PARAMS.cUrl,
            !(SEND_PARAMS.cToken === "true")
          )
          : callAjaxGETApiAny(
            cUrl,
            paramS,
            null,
            !(SEND_PARAMS.cToken === "true")
          );
    }

    if (ajaxSend) {
      // giả lập lệnh đang chạy không cho bấm tiếp theo
      // $("body").addClass("loading");
      fakeLoading(20000, 200);
      ajaxSend
        .then((result) => {
          // $("body").removeClass("loading");
          // console.log("Kết quả", result);
          showToast("success", `Đã gửi lệnh thành công`, null, 1000);
          // xét phương thức tiếp theo để xử lý form này
          // CLOSE, RESET, next-page.html
          if (SEND_PARAMS.cNext === "CLOSE") {
            // di chuyển sang trang trước
            //
            window.history.back();
          } else if (SEND_PARAMS.cNext === "VIEW") {
            // hiển thị kết quả lấy được ra màn hình
            showResultApiData(formDatas, result);
          } else if (SEND_PARAMS.cNext === "RESET") {
            // reset trang làm mới lại
            //
            window.location.reload();
          } else if (!SEND_PARAMS.cNext) {
            //
            // chuyển tiếp sang trang khai trong này
            window.location.href = SEND_PARAMS.cNext;
          }
          showHideLoading(false);
        })
        .catch((err) => {
          // $("body").removeClass("loading");
          showApiError(err, true);
          showHideLoading(false);
        });
    }
  }

  function prepairNextPreviousPageButtons(formDatas, SEND_PARAMS) {
    $(".btn-read-next").click(function () {
      let jsonNew = { ...SEND_PARAMS.jsonData };
      callSendData(formDatas, SEND_PARAMS, jsonNew.page + 1);
    });

    $(".btn-read-prev").click(function () {
      let jsonNew = { ...SEND_PARAMS.jsonData };
      callSendData(formDatas, SEND_PARAMS, jsonNew.page - 1);
    });
  }

  // hiển thị kết quả dữ liệu lên form khi query ra
  function showResultApiData(formDatas, result) {
    if (
      result &&
      Array.isArray(result) &&
      result.length
    ) {
      HOME_PARAMS.sheetDatas = result;

      if (HOME_PARAMS.sheetDatas.length) {
        viewTableData(formDatas, HOME_PARAMS.sheetDatas);
      }
      $(".btn-current-page").text(1);
      $(".btn-current-limit").text(result.length);
      // $(".btn-current-page").text(result.page);
      // $(".btn-current-limit").text(result.limit);

      $(".btn-current-page").show();
      $(".btn-current-limit").show();
      $(".btn-table-export").show();

      if (result.page > 1) {
        $(".btn-read-prev").show();
      } else {
        $(".btn-read-prev").hide();
      }
      if (result.next_page > result.page) {
        $(".btn-read-next").show();
      } else {
        $(".btn-read-next").hide();
      }
    } else {
      $(".btn-read-next").hide();
    }
  }

  // thực thi lệnh sau xác nhận
  function doCommandAfterConfirm(cmd, rowId) {
    const headers = ["commands", "id"];
    const $row = $(`#${rowId}`);
    const jsonData = {};
    $row.each(function () {
      const $td = $(this).find("td");
      headers.forEach((header, i) => {
        if (i) jsonData[header] = $td.eq(i).text(); // bỏ qua cột số 1
      });
    });
    // so sánh dữ liệu soạn thảo và dữ liệu gốc trong chuỗi
    // let jsonOrg = HOME_PARAMS.sheetDatas.find(x=>""+x.id===id);
    // console.log("Xác nhận xóa file", cmd, jsonData);
    // nếu 2 jsonData, jsonOrg này có thay đổi dữ liệu mà lệnh update thì có hiệu lực
    switch (cmd) {
      case "R":
        // đọc lấy nội dung của file này xem để lấy xuống máy luôn
        showToast(
          "success",
          `Đã đọc xong file #${jsonData.id}`,
          "toast-top-center",
          3000,
          true
        );
        break;
      case "U":
        // update 
        showToast(
          "success",
          `Đã CẬP NHẬP file #${jsonData.id} thành công`,
          "toast-top-center",
          3000,
          true
        );
        break;
      case "D":
        // xóa 
        $row.detach();
        showToast(
          "success",
          `Đã XÓA file #${jsonData.id} thành công`,
          "toast-top-center",
          3000,
          true
        );
        break;
      default:
        break;
    }

    $("#confirm-crud-command").modal("hide");
  }

  // thực thi các lệnh trên dòng
  function doCommandOneRow(thisObj, cmd) {

    const $row = $(thisObj).parents("tr");
    let msg = cmd === "D" ? `XÓA file này khỏi cloud` : cmd === "U" ? `CẬP NHẬP thông tin lên cloud` : cmd === "R" ? `TẢI file từ cloud xuống` : cmd || ``;
    let htmlForm = `<h5>XÁC NHẬN</h5>
                          <hr>
                          Bạn muốn ${msg}?
                          <hr>
                          <div class="text-right">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Bỏ qua</button>
                            <button type="button" class="btn btn-primary" onclick="doCommandAfterConfirm('${cmd}','${$row.attr("id")}');">Đồng ý</button>
                          </div>`;
    $(".modal-body").html(htmlForm);
    $("#confirm-crud-command").modal("toggle");
    $("#confirm-crud-command").modal("show");
  }

  /**
   * Hiển thị nội dung ra bảng
   */
  function viewTableData(formDatas, result) {
    // khai báo các nút lệnh trên từng dòng để khai báo xóa file và chỉnh sửa file
    let buttons = `<button type="button" class="btn btn-sm btn-rounded btn-primary btn-read-one" onclick="doCommandOneRow(this,'R');">
                  <i class="fa fa-download icon"></i> Xem
                  </button>
                  <button type="button" class="btn btn-sm btn-rounded btn-success btn-read-one" onclick="doCommandOneRow(this,'U');">
                  <i class="fa fa-edit icon"></i> Sửa
                  </button>
                  <button type="button" class="btn btn-sm btn-rounded btn-danger btn-read-one" onclick="doCommandOneRow(this,'D');">
                  <i class="fa fa-trash icon"></i> Xóa
                  </button>`;

    let headers = {
      // id: 1,
      // name: 2,
      // type: 1,
      // size: 1,
      // updated_time: 1,
      // owner: 1,
      // is_private: 2,
      // url_user: 0,
      // url_local: 0,
      // created_time: 0
    };

    // Tạo một bảng dữ liệu theo kết quả lấy được, khai trường "id" làm id của dòng để tham chiếu duy nhất
    let htmlTable = formDatas.arrayObject2HtmlTable(result, headers, null, false, false);

    // console.log("Kết quả ", htmlTable);

    if (htmlTable) {
      $("#dynamic-table").html(htmlTable);
      // cập nhập bảng
      $("#table-datatables").DataTable({
        drawCallback: function (settings) {
          $("#table-datatables").reflowTable("update");
        },
        scrollX: "100%",
        scrollY: "300px",
        ...HOME_PARAMS.DATA_TABLE_PAGING,
      });
      // chỉ hiển thị ở chế độ mobile thôi
      $("#table-datatables").reflowTable({
        autoWidth: false,
      });
      // .mobileMode(true);
    }
  }

  function createExcelFile(fileName, sheetName, sheetResult, headers) {
    const ws = XLSX.utils.json_to_sheet(sheetResult, { headers });
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, sheetName);
    XLSX.writeFile(wb, fileName);
  }
</script>
<!-- Hết code javascript riêng -->